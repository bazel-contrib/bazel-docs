<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="en" class="no-js">
  <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>A Guide to Skyframe `StateMachine`s | Bazel Documentation</title>
<meta name="description" content="Overview A Skyframe StateMachine is a deconstructed function-object that resides on the heap. It supports flexible and evaluation without redundancy1 when required values are not immediately available but computed asynchronously. The StateMachine cannot tie up a thread resource while waiting, but instead has to be suspended and resumed. The deconstruction thus exposes explicit re-entry points so that prior computations can be skipped.
StateMachines can be used to express sequences, branching, structured logical concurrency and are tailored specifically for Skyframe interaction. StateMachines can be composed into larger StateMachines and share sub-StateMachines. Concurrency is always hierarchical by construction and purely logical. Every concurrent subtask runs in the single shared parent SkyFunction thread.">
<meta property="og:url" content="http://localhost:1313/contribute/statemachine-guide/">
  <meta property="og:site_name" content="Bazel Documentation">
  <meta property="og:title" content="A Guide to Skyframe `StateMachine`s">
  <meta property="og:description" content="Overview A Skyframe StateMachine is a deconstructed function-object that resides on the heap. It supports flexible and evaluation without redundancy1 when required values are not immediately available but computed asynchronously. The StateMachine cannot tie up a thread resource while waiting, but instead has to be suspended and resumed. The deconstruction thus exposes explicit re-entry points so that prior computations can be skipped.
StateMachines can be used to express sequences, branching, structured logical concurrency and are tailored specifically for Skyframe interaction. StateMachines can be composed into larger StateMachines and share sub-StateMachines. Concurrency is always hierarchical by construction and purely logical. Every concurrent subtask runs in the single shared parent SkyFunction thread.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="contribute">
    <meta property="article:published_time" content="2024-01-01T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-01-01T00:00:00+00:00">

  <meta itemprop="name" content="A Guide to Skyframe `StateMachine`s">
  <meta itemprop="description" content="Overview A Skyframe StateMachine is a deconstructed function-object that resides on the heap. It supports flexible and evaluation without redundancy1 when required values are not immediately available but computed asynchronously. The StateMachine cannot tie up a thread resource while waiting, but instead has to be suspended and resumed. The deconstruction thus exposes explicit re-entry points so that prior computations can be skipped.
StateMachines can be used to express sequences, branching, structured logical concurrency and are tailored specifically for Skyframe interaction. StateMachines can be composed into larger StateMachines and share sub-StateMachines. Concurrency is always hierarchical by construction and purely logical. Every concurrent subtask runs in the single shared parent SkyFunction thread.">
  <meta itemprop="datePublished" content="2024-01-01T00:00:00+00:00">
  <meta itemprop="dateModified" content="2024-01-01T00:00:00+00:00">
  <meta itemprop="wordCount" content="5563">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="A Guide to Skyframe `StateMachine`s">
  <meta name="twitter:description" content="Overview A Skyframe StateMachine is a deconstructed function-object that resides on the heap. It supports flexible and evaluation without redundancy1 when required values are not immediately available but computed asynchronously. The StateMachine cannot tie up a thread resource while waiting, but instead has to be suspended and resumed. The deconstruction thus exposes explicit re-entry points so that prior computations can be skipped.
StateMachines can be used to express sequences, branching, structured logical concurrency and are tailored specifically for Skyframe interaction. StateMachines can be composed into larger StateMachines and share sub-StateMachines. Concurrency is always hierarchical by construction and purely logical. Every concurrent subtask runs in the single shared parent SkyFunction thread.">
<link href="/scss/main.css" rel="stylesheet">
<script
  src="https://code.jquery.com/jquery-3.7.1.min.js"
  integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
  crossorigin="anonymous"></script>

  </head>
  <body class="td-page">
    <header>
      <nav class="td-navbar js-navbar-scroll" data-bs-theme="dark">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">Bazel Documentation</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="/docs/"><span>Documentation</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/community/"><span>Community</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/about/"><span>About</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            <div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ms-3 fas fa-bars" type="button" data-bs-toggle="collapse" data-bs-target="#td-section-nav" aria-controls="td-section-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="td-sidebar-nav collapse" id="td-section-nav">
    <ul class="td-sidebar-nav__section pe-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m--li">
  <a href="/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-"><span class="">Bazel Documentation</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-help-li">
  <a href="/help/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-help"><span class="">Getting Help</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-concepts-li">
  <a href="/concepts/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-concepts"><span class="">Understanding Bazel</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-conceptsbuild-files-li">
  <a href="/concepts/build-files/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-conceptsbuild-files"><span class="">BUILD files</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-conceptsdependencies-li">
  <a href="/concepts/dependencies/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-conceptsdependencies"><span class="">Dependencies</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-conceptslabels-li">
  <a href="/concepts/labels/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-conceptslabels"><span class="">Labels</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-conceptsplatforms-li">
  <a href="/concepts/platforms/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-conceptsplatforms"><span class="">Migrating to Platforms</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-conceptsbuild-ref-li">
  <a href="/concepts/build-ref/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-conceptsbuild-ref"><span class="">Repositories, workspaces, packages, and targets</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-conceptsvisibility-li">
  <a href="/concepts/visibility/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-conceptsvisibility"><span class="">Visibility</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-basics-li">
  <a href="/basics/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-basics"><span class="">Basics</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-basicsartifact-based-builds-li">
  <a href="/basics/artifact-based-builds/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-basicsartifact-based-builds"><span class="">Artifact-Based Build Systems</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-basicsdependencies-li">
  <a href="/basics/dependencies/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-basicsdependencies"><span class="">Dependency Management</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-basicsdistributed-builds-li">
  <a href="/basics/distributed-builds/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-basicsdistributed-builds"><span class="">Distributed Builds</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-basicshermeticity-li">
  <a href="/basics/hermeticity/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-basicshermeticity"><span class="">Hermeticity</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-basicstask-based-builds-li">
  <a href="/basics/task-based-builds/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-basicstask-based-builds"><span class="">Task-Based Build Systems</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-basicsbuild-systems-li">
  <a href="/basics/build-systems/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-basicsbuild-systems"><span class="">Why a Build System?</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-tutorials-li">
  <a href="/tutorials/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-tutorials"><span class="">Tutorials</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-tutorialsccp-toolchain-config-li">
  <a href="/tutorials/ccp-toolchain-config/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-tutorialsccp-toolchain-config"><span class="">Bazel Tutorial: Configure C&#43;&#43; Toolchains</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-tutorialscpp-use-cases-li">
  <a href="/tutorials/cpp-use-cases/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-tutorialscpp-use-cases"><span class="">Common C&#43;&#43; Build Use Cases</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-tutorialscpp-dependency-li">
  <a href="/tutorials/cpp-dependency/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-tutorialscpp-dependency"><span class="">Review the dependency graph</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-tutorialscpp-labels-li">
  <a href="/tutorials/cpp-labels/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-tutorialscpp-labels"><span class="">Use labels to reference targets</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-configure-li">
  <a href="/configure/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-configure"><span class="">Configure</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-configurebest-practices-li">
  <a href="/configure/best-practices/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-configurebest-practices"><span class="">Best Practices</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-configurecoverage-li">
  <a href="/configure/coverage/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-configurecoverage"><span class="">Code coverage with Bazel</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-configureattributes-li">
  <a href="/configure/attributes/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-configureattributes"><span class="">Configurable Build Attributes</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-configureintegrate-cpp-li">
  <a href="/configure/integrate-cpp/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-configureintegrate-cpp"><span class="">Integrating with C&#43;&#43; Rules</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-configurewindows-li">
  <a href="/configure/windows/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-configurewindows"><span class="">Using Bazel on Windows</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-extending-li">
  <a href="/extending/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-extending"><span class="">Extending Bazel</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-extendingaspects-li">
  <a href="/extending/aspects/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-extendingaspects"><span class="">Aspects</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-extendingauto-exec-groups-li">
  <a href="/extending/auto-exec-groups/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-extendingauto-exec-groups"><span class="">Automatic Execution Groups (AEGs)</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-extendingconfig-li">
  <a href="/extending/config/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-extendingconfig"><span class="">Configurations</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-extendingdepsets-li">
  <a href="/extending/depsets/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-extendingdepsets"><span class="">Depsets</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-extendingexec-groups-li">
  <a href="/extending/exec-groups/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-extendingexec-groups"><span class="">Execution Groups</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-extendingconcepts-li">
  <a href="/extending/concepts/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-extendingconcepts"><span class="">Extension Overview</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-extendinglegacy-macros-li">
  <a href="/extending/legacy-macros/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-extendinglegacy-macros"><span class="">Legacy Macros</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-extendingmacros-li">
  <a href="/extending/macros/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-extendingmacros"><span class="">Macros</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-extendingplatforms-li">
  <a href="/extending/platforms/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-extendingplatforms"><span class="">Platforms</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-extendingrules-li">
  <a href="/extending/rules/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-extendingrules"><span class="">Rules</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-extendingtoolchains-li">
  <a href="/extending/toolchains/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-extendingtoolchains"><span class="">Toolchains</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-external-li">
  <a href="/external/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-external"><span class="">External</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-externalmod-command-li">
  <a href="/external/mod-command/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-externalmod-command"><span class="">`mod` Command</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-externallockfile-li">
  <a href="/external/lockfile/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-externallockfile"><span class="">Bazel Lockfile</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-externalmodule-li">
  <a href="/external/module/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-externalmodule"><span class="">Bazel modules</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-externalregistry-li">
  <a href="/external/registry/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-externalregistry"><span class="">Bazel registries</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-externalmigration-li">
  <a href="/external/migration/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-externalmigration"><span class="">Bzlmod Migration Guide</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-externaloverview-li">
  <a href="/external/overview/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-externaloverview"><span class="">External dependencies overview</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-externalfaq-li">
  <a href="/external/faq/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-externalfaq"><span class="">Frequently asked questions</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-externalextension-li">
  <a href="/external/extension/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-externalextension"><span class="">Module extensions</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-externalrepo-li">
  <a href="/external/repo/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-externalrepo"><span class="">Repository Rules</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-externalvendor-li">
  <a href="/external/vendor/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-externalvendor"><span class="">Vendor Mode</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-externalimages-li">
  <a href="/external/images/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-externalimages"><span class="">Images</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-remote-li">
  <a href="/remote/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-remote"><span class="">Remote</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remoterules-li">
  <a href="/remote/rules/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remoterules"><span class="">Adapting Bazel Rules for Remote Execution</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remotebep-li">
  <a href="/remote/bep/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remotebep"><span class="">Build Event Protocol</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remotebep-examples-li">
  <a href="/remote/bep-examples/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remotebep-examples"><span class="">Build Event Protocol Examples</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remotebep-glossary-li">
  <a href="/remote/bep-glossary/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remotebep-glossary"><span class="">Build Event Protocol Glossary</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remoteci-li">
  <a href="/remote/ci/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remoteci"><span class="">Configuring Bazel CI to Test Rules for Remote Execution</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remotecreating-li">
  <a href="/remote/creating/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remotecreating"><span class="">Creating Persistent Workers</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remotecache-local-li">
  <a href="/remote/cache-local/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remotecache-local"><span class="">Debugging Remote Cache Hits for Local Execution</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remotecache-remote-li">
  <a href="/remote/cache-remote/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remotecache-remote"><span class="">Debugging Remote Cache Hits for Remote Execution</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remotedynamic-li">
  <a href="/remote/dynamic/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remotedynamic"><span class="">Dynamic Execution</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remoteworkspace-li">
  <a href="/remote/workspace/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remoteworkspace"><span class="">Finding Non-Hermetic Behavior in WORKSPACE Rules</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remotemultiplex-li">
  <a href="/remote/multiplex/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remotemultiplex"><span class="">Multiplex Workers (Experimental Feature)</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remoteoutput-directories-li">
  <a href="/remote/output-directories/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remoteoutput-directories"><span class="">Output Directory Layout</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remotepersistent-li">
  <a href="/remote/persistent/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remotepersistent"><span class="">Persistent Workers</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remotecaching-li">
  <a href="/remote/caching/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remotecaching"><span class="">Remote Caching</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remoterbe-li">
  <a href="/remote/rbe/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remoterbe"><span class="">Remote Execution Overview</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-remotesandbox-li">
  <a href="/remote/sandbox/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-remotesandbox"><span class="">Troubleshooting Bazel Remote Execution with Docker Sandbox</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-query-li">
  <a href="/query/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-query"><span class="">Query</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-queryaquery-li">
  <a href="/query/aquery/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-queryaquery"><span class="">Action Graph Query (aquery)</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-querycquery-li">
  <a href="/query/cquery/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-querycquery"><span class="">Configurable Query (cquery)</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-queryguide-li">
  <a href="/query/guide/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-queryguide"><span class="">Query guide</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-queryquickstart-li">
  <a href="/query/quickstart/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-queryquickstart"><span class="">Query quickstart</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-querylanguage-li">
  <a href="/query/language/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-querylanguage"><span class="">The Bazel Query Reference</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-queryimages-li">
  <a href="/query/images/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-queryimages"><span class="">Images</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-advanced-li">
  <a href="/advanced/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-advanced"><span class="">Advanced</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-advancedperformance-li">
  <a href="/advanced/performance/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-advancedperformance"><span class="">Performance</span></a>
  <ul class="ul-3 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-advancedperformancebuild-performance-breakdown-li">
  <a href="/advanced/performance/build-performance-breakdown/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-advancedperformancebuild-performance-breakdown"><span class="">Breaking down build performance</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-advancedperformancebuild-performance-metrics-li">
  <a href="/advanced/performance/build-performance-metrics/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-advancedperformancebuild-performance-metrics"><span class="">Extracting build performance metrics</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-advancedperformancejson-trace-profile-li">
  <a href="/advanced/performance/json-trace-profile/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-advancedperformancejson-trace-profile"><span class="">JSON Trace Profile</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-advancedperformanceiteration-speed-li">
  <a href="/advanced/performance/iteration-speed/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-advancedperformanceiteration-speed"><span class="">Optimize Iteration Speed</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-advancedperformancememory-li">
  <a href="/advanced/performance/memory/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-advancedperformancememory"><span class="">Optimize Memory</span></a>
</li>
  </ul>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-install-li">
  <a href="/install/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-install"><span class="">Install</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-installcompletion-li">
  <a href="/install/completion/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-installcompletion"><span class="">Command-Line Completion</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-installcompile-source-li">
  <a href="/install/compile-source/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-installcompile-source"><span class="">Compiling Bazel from Source</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-installdocker-container-li">
  <a href="/install/docker-container/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-installdocker-container"><span class="">Getting Started with Bazel Docker Container</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-installbazelisk-li">
  <a href="/install/bazelisk/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-installbazelisk"><span class="">Installing / Updating Bazel using Bazelisk</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-installos-x-li">
  <a href="/install/os-x/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-installos-x"><span class="">Installing Bazel on macOS</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-installsuse-li">
  <a href="/install/suse/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-installsuse"><span class="">Installing Bazel on openSUSE Tumbleweed &amp; Leap</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-installubuntu-li">
  <a href="/install/ubuntu/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-installubuntu"><span class="">Installing Bazel on Ubuntu</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-installwindows-li">
  <a href="/install/windows/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-installwindows"><span class="">Installing Bazel on Windows</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-installide-li">
  <a href="/install/ide/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-installide"><span class="">Integrating Bazel with IDEs</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-installimages-li">
  <a href="/install/images/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-installimages"><span class="">Images</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-migrate-li">
  <a href="/migrate/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-migrate"><span class="">Migrate</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-migratemaven-li">
  <a href="/migrate/maven/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-migratemaven"><span class="">Migrating from Maven to Bazel</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-migratexcode-li">
  <a href="/migrate/xcode/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-migratexcode"><span class="">Migrating from Xcode to Bazel</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-reference-li">
  <a href="/reference/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-reference"><span class="">Reference</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-referenceflag-cheatsheet-li">
  <a href="/reference/flag-cheatsheet/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-referenceflag-cheatsheet"><span class="">Bazel flag cheat sheet</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-referenceglossary-li">
  <a href="/reference/glossary/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-referenceglossary"><span class="">Bazel Glossary</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-referenceskyframe-li">
  <a href="/reference/skyframe/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-referenceskyframe"><span class="">Skyframe</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-referencetest-encyclopedia-li">
  <a href="/reference/test-encyclopedia/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-referencetest-encyclopedia"><span class="">Test encyclopedia</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-release-li">
  <a href="/release/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-release"><span class="">Release</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-releasebackward-compatibility-li">
  <a href="/release/backward-compatibility/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-releasebackward-compatibility"><span class="">Backward Compatibility</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-releaserolling-li">
  <a href="/release/rolling/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-releaserolling"><span class="">Rolling Releases</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-releaserule-compatibility-li">
  <a href="/release/rule-compatibility/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-releaserule-compatibility"><span class="">Rule Compatibility</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-rules-li">
  <a href="/rules/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-rules"><span class="">Rules</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-rulesbzl-style-li">
  <a href="/rules/bzl-style/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-rulesbzl-style"><span class="">.bzl style guide</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ruleschallenges-li">
  <a href="/rules/challenges/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-ruleschallenges"><span class="">Challenges of Writing Rules</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ruleslegacy-macro-tutorial-li">
  <a href="/rules/legacy-macro-tutorial/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-ruleslegacy-macro-tutorial"><span class="">Creating a Legacy Macro</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-rulesmacro-tutorial-li">
  <a href="/rules/macro-tutorial/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-rulesmacro-tutorial"><span class="">Creating a Symbolic Macro</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-rulesdeploying-li">
  <a href="/rules/deploying/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-rulesdeploying"><span class="">Deploying Rules</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-ruleserrors-li">
  <a href="/rules/errors/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-ruleserrors"><span class="">Errors</span></a>
  <ul class="ul-3 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ruleserrorsread-only-variable-li">
  <a href="/rules/errors/read-only-variable/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-ruleserrorsread-only-variable"><span class="">Error: Variable x is read only</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-rulesfaq-li">
  <a href="/rules/faq/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-rulesfaq"><span class="">Frequently Asked Questions</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-rulesperformance-li">
  <a href="/rules/performance/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-rulesperformance"><span class="">Optimizing Performance</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-rulesrules-tutorial-li">
  <a href="/rules/rules-tutorial/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-rulesrules-tutorial"><span class="">Rules Tutorial</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ruleslanguage-li">
  <a href="/rules/language/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-ruleslanguage"><span class="">Starlark Language</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-rulestesting-li">
  <a href="/rules/testing/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-rulestesting"><span class="">Testing</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-rulesverbs-tutorial-li">
  <a href="/rules/verbs-tutorial/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-rulesverbs-tutorial"><span class="">Using Macros to Create Custom Verbs</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-ruleswindows-li">
  <a href="/rules/windows/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-ruleswindows"><span class="">Writing Rules on Windows</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-run-li">
  <a href="/run/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-run"><span class="">Run</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-runbuild-li">
  <a href="/run/build/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-runbuild"><span class="">Build programs with Bazel</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-runscripts-li">
  <a href="/run/scripts/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-runscripts"><span class="">Calling Bazel from scripts</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-runclient-server-li">
  <a href="/run/client-server/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-runclient-server"><span class="">Client/server implementation</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-runbazelrc-li">
  <a href="/run/bazelrc/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-runbazelrc"><span class="">Write bazelrc configuration files</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-start-li">
  <a href="/start/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-start"><span class="">Start</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-startcpp-li">
  <a href="/start/cpp/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-startcpp"><span class="">Bazel Tutorial: Build a C&#43;&#43; Project</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-startgo-li">
  <a href="/start/go/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-startgo"><span class="">Bazel Tutorial: Build a Go Project</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-startjava-li">
  <a href="/start/java/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-startjava"><span class="">Bazel Tutorial: Build a Java Project</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-startandroid-app-li">
  <a href="/start/android-app/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-startandroid-app"><span class="">Bazel Tutorial: Build an Android App</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-startios-app-li">
  <a href="/start/ios-app/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-startios-app"><span class="">Bazel Tutorial: Build an iOS App</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docs-li">
  <a href="/docs/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docs"><span class="">Using Bazel</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsbazel-and-android-li">
  <a href="/docs/bazel-and-android/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docsbazel-and-android"><span class="">Android and Bazel</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsandroid-build-performance-li">
  <a href="/docs/android-build-performance/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docsandroid-build-performance"><span class="">Android Build Performance</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsandroid-instrumentation-test-li">
  <a href="/docs/android-instrumentation-test/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docsandroid-instrumentation-test"><span class="">Android Instrumentation Tests</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsbazel-and-apple-li">
  <a href="/docs/bazel-and-apple/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docsbazel-and-apple"><span class="">Apple Apps and Bazel</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsmobile-install-li">
  <a href="/docs/mobile-install/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docsmobile-install"><span class="">bazel mobile-install</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsbazel-and-cpp-li">
  <a href="/docs/bazel-and-cpp/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docsbazel-and-cpp"><span class="">C&#43;&#43; and Bazel</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docscc-toolchain-config-reference-li">
  <a href="/docs/cc-toolchain-config-reference/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docscc-toolchain-config-reference"><span class="">C&#43;&#43; Toolchain Configuration</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsuser-manual-li">
  <a href="/docs/user-manual/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docsuser-manual"><span class="">Commands and Options</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsconfigurable-attributes-li">
  <a href="/docs/configurable-attributes/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docsconfigurable-attributes"><span class="">Configurable Build Attributes</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsbazel-and-java-li">
  <a href="/docs/bazel-and-java/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docsbazel-and-java"><span class="">Java and Bazel</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsbazel-and-javascript-li">
  <a href="/docs/bazel-and-javascript/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docsbazel-and-javascript"><span class="">JavaScript and Bazel</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docssandboxing-li">
  <a href="/docs/sandboxing/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docssandboxing"><span class="">Sandboxing</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsandroid-ndk-li">
  <a href="/docs/android-ndk/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-docsandroid-ndk"><span class="">Using the Android Native Development Kit with Bazel</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsimages-li">
  <a href="/docs/images/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-docsimages"><span class="">Images</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-brand-li">
  <a href="/brand/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-brand"><span class="">Brand</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-images-li">
  <a href="/images/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-images"><span class="">Images</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-versions-li">
  <a href="/versions/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-versions"><span class="">Versions</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-community-li">
  <a href="/community/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-community"><span class="">Community &amp; Product Partners</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-communityroadmaps-configurability-li">
  <a href="/community/roadmaps-configurability/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-communityroadmaps-configurability"><span class="">Bazel Configurability 2021 Roadmap</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-communitysig-li">
  <a href="/community/sig/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-communitysig"><span class="">Bazel Special Interest Groups</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-communityupdate-li">
  <a href="/community/update/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-communityupdate"><span class="">Community updates</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-communityrecommended-rules-li">
  <a href="/community/recommended-rules/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-communityrecommended-rules"><span class="">Recommended Rules</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-communityremote-execution-services-li">
  <a href="/community/remote-execution-services/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-communityremote-execution-services"><span class="">Remote Execution Services</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-communityroadmaps-starlark-li">
  <a href="/community/roadmaps-starlark/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-communityroadmaps-starlark"><span class="">Starlark Roadmap</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-communityusers-li">
  <a href="/community/users/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-communityusers"><span class="">Who&#39;s Using Bazel</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-communityexperts-li">
  <a href="/community/experts/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-communityexperts"><span class="">Experts</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-communityimages-li">
  <a href="/community/images/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-communityimages"><span class="">Images</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-communitypartners-li">
  <a href="/community/partners/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-communitypartners"><span class="">Partners</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-contribute-li">
  <a href="/contribute/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-contribute"><span class="">Contribute</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-contributestatemachine-guide-li">
  <a href="/contribute/statemachine-guide/" class="align-left ps-0 active td-sidebar-link td-sidebar-link__page" id="m-contributestatemachine-guide"><span class="td-sidebar-nav-active-item">A Guide to Skyframe `StateMachine`s</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-contributedocs-style-guide-li">
  <a href="/contribute/docs-style-guide/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-contributedocs-style-guide"><span class="">Bazel docs style guide</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-contributedocs-li">
  <a href="/contribute/docs/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-contributedocs"><span class="">Contribute to Bazel documentation</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-contributepolicy-li">
  <a href="/contribute/policy/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-contributepolicy"><span class="">Contribution policy</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-contributedesign-documents-li">
  <a href="/contribute/design-documents/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-contributedesign-documents"><span class="">Design Documents</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-contributemaintainers-guide-li">
  <a href="/contribute/maintainers-guide/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-contributemaintainers-guide"><span class="">Guide for Bazel Maintainers</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-contributebreaking-changes-li">
  <a href="/contribute/breaking-changes/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-contributebreaking-changes"><span class="">Guide for rolling out breaking changes</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-contributewindows-chocolatey-maintenance-li">
  <a href="/contribute/windows-chocolatey-maintenance/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-contributewindows-chocolatey-maintenance"><span class="">Maintaining Bazel Chocolatey package on Windows</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-contributewindows-scoop-maintenance-li">
  <a href="/contribute/windows-scoop-maintenance/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-contributewindows-scoop-maintenance"><span class="">Maintaining Bazel Scoop package on Windows</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-contributenaming-li">
  <a href="/contribute/naming/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-contributenaming"><span class="">Naming a Bazel related project</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-contributepatch-acceptance-li">
  <a href="/contribute/patch-acceptance/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-contributepatch-acceptance"><span class="">Patch Acceptance Process</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-contributesearch-li">
  <a href="/contribute/search/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-contributesearch"><span class="">Searching the codebase</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-contributecodebase-li">
  <a href="/contribute/codebase/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-contributecodebase"><span class="">The Bazel codebase</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-contributerelease-notes-li">
  <a href="/contribute/release-notes/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-contributerelease-notes"><span class="">Writing release notes</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-contributeimages-li">
  <a href="/contribute/images/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-contributeimages"><span class="">Images</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-about-li">
  <a href="/about/" class="align-left ps-0 td-sidebar-link td-sidebar-link__section" id="m-about"><span class="">About</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-aboutroadmap-li">
  <a href="/about/roadmap/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-aboutroadmap"><span class="">Bazel roadmap</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-aboutvision-li">
  <a href="/about/vision/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-aboutvision"><span class="">Bazel Vision</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-aboutfaq-li">
  <a href="/about/faq/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-aboutfaq"><span class="">FAQ</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-aboutintro-li">
  <a href="/about/intro/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-aboutintro"><span class="">Intro to Bazel</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-aboutwhy-li">
  <a href="/about/why/" class="align-left ps-0 td-sidebar-link td-sidebar-link__page" id="m-aboutwhy"><span class="">Why Bazel?</span></a>
</li>
  </ul>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            <div class="td-page-meta ms-2 pb-1 pt-2 mb-0">
<a href="https://github.com/bazelbuild/bazel/tree/master/site/en/content/contribute/statemachine-guide.md" class="td-page-meta--view td-page-meta__view" target="_blank" rel="noopener"><i class="fa-solid fa-file-lines fa-fw"></i> View page source</a>
  <a href="https://github.com/bazelbuild/bazel/edit/master/site/en/content/contribute/statemachine-guide.md" class="td-page-meta--edit td-page-meta__edit" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Edit this page</a>
  <a href="https://github.com/bazelbuild/bazel/new/master/site/en/content/contribute?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child td-page-meta__child" target="_blank" rel="noopener"><i class="fa-solid fa-pen-to-square fa-fw"></i> Create child page</a>
  <a href="https://github.com/bazelbuild/bazel/issues/new?title=A%20Guide%20to%20Skyframe%20%60StateMachine%60s" class="td-page-meta--issue td-page-meta__issue" target="_blank" rel="noopener"><i class="fa-solid fa-list-check fa-fw"></i> Create documentation issue</a>
  
</div>

            <div class="td-toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#overview">Overview</a></li>
    <li><a href="#introduction">Introduction</a>
      <ul>
        <li><a href="#a-brief-introduction-to-skyframe-restarts">A brief introduction to Skyframe restarts</a></li>
        <li><a href="#stateful-computations-inside-skykeycomputestate">Stateful computations inside <code>SkyKeyComputeState</code></a></li>
        <li><a href="#callbacks-continuations-and-asynchronous-computation">Callbacks, continuations and asynchronous computation</a></li>
      </ul>
    </li>
    <li><a href="#tasks">Tasks</a>
      <ul>
        <li><a href="#skyvalue-lookups">SkyValue lookups</a></li>
        <li><a href="#subtasks">Subtasks</a></li>
        <li><a href="#structured-concurrency">Structured concurrency</a></li>
      </ul>
    </li>
    <li><a href="#composition-and-control-flow-patterns">Composition and control flow patterns</a>
      <ul>
        <li><a href="#sequential-states">Sequential states</a></li>
        <li><a href="#branching">Branching</a></li>
        <li><a href="#advanced-sequential-composition">Advanced sequential composition</a></li>
        <li><a href="#direct-delegation">Direct delegation</a></li>
      </ul>
    </li>
    <li><a href="#data-flow">Data flow</a>
      <ul>
        <li><a href="#implementing-taskslookup-callbacks">Implementing <code>Tasks.lookUp</code> callbacks</a></li>
        <li><a href="#propagating-values-between-statemachines">Propagating values between <code>StateMachine</code>s</a></li>
        <li><a href="#error-handling">Error handling</a></li>
        <li><a href="#event-handling">Event Handling</a></li>
      </ul>
    </li>
    <li><a href="#drivers-and-bridging-to-skyfunctions"><code>Driver</code>s and bridging to SkyFunctions</a>
      <ul>
        <li><a href="#directly-instantiating-driver">Directly instantiating <code>Driver</code></a></li>
        <li><a href="#embedding-driver">Embedding <code>Driver</code></a></li>
        <li><a href="#statemachines-that-may-produce-exceptions">StateMachines that may produce exceptions</a></li>
      </ul>
    </li>
    <li><a href="#epilogue-eventually-removing-callbacks">Epilogue: Eventually removing callbacks</a></li>
    <li><a href="#appendix">Appendix</a>
      <ul>
        <li><a href="#callback-hell">Callback Hell</a></li>
        <li><a href="#miscellaneous-tips">Miscellaneous Tips</a></li>
        <li><a href="#concurrency-tree-diagram">Concurrency tree diagram</a></li>
      </ul>
    </li>
  </ul>
</nav>
      </div>
    
            
	
          </aside>
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="td-breadcrumbs">
  <ol class="breadcrumb">
  <li class="breadcrumb-item">
    <a href="/contribute/">Contribute</a></li>
  <li class="breadcrumb-item active" aria-current="page">
    A Guide to Skyframe `StateMachine`s</li>
  </ol>
</nav>
<div class="td-content">
	<h1>A Guide to Skyframe `StateMachine`s</h1>
	
	<header class="article-meta">
		
  </header>
	<h2 id="overview">Overview</h2>
<p>A Skyframe <code>StateMachine</code> is a <em>deconstructed</em> function-object that resides on
the heap. It supports flexible and evaluation without redundancy<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> when
required values are not immediately available but computed asynchronously. The
<code>StateMachine</code> cannot tie up a thread resource while waiting, but instead has to
be suspended and resumed. The deconstruction thus exposes explicit re-entry
points so that prior computations can be skipped.</p>
<p><code>StateMachine</code>s can be used to express sequences, branching, structured logical
concurrency and are tailored specifically for Skyframe interaction.
<code>StateMachine</code>s can be composed into larger <code>StateMachine</code>s and share
sub-<code>StateMachine</code>s. Concurrency is always hierarchical by construction and
purely logical. Every concurrent subtask runs in the single shared parent
SkyFunction thread.</p>
<h2 id="introduction">Introduction</h2>
<p>This section briefly motivates and introduces <code>StateMachine</code>s, found in the
<a href="https://github.com/bazelbuild/bazel/tree/master/src/main/java/com/google/devtools/build/skyframe/state"><code>java.com.google.devtools.build.skyframe.state</code></a>
package.</p>
<h3 id="a-brief-introduction-to-skyframe-restarts">A brief introduction to Skyframe restarts</h3>
<p>Skyframe is a framework that performs parallel evaluation of dependency graphs.
Each node in the graph corresponds with the evaluation of a SkyFunction with a
SkyKey specifying its parameters and SkyValue specifying its result. The
computational model is such that a SkyFunction may lookup SkyValues by SkyKey,
triggering recursive, parallel evaluation of additional SkyFunctions. Instead of
blocking, which would tie up a thread, when a requested SkyValue is not yet
ready because some subgraph of computation is incomplete, the requesting
SkyFunction observes a <code>null</code> <code>getValue</code> response and should return <code>null</code>
instead of a SkyValue, signaling that it is incomplete due to missing inputs.
Skyframe <em>restarts</em> the SkyFunctions when all previously requested SkyValues
become available.</p>
<p>Before the introduction of <code>SkyKeyComputeState</code>, the traditional way of handling
a restart was to fully rerun the computation. Although this has quadratic
complexity, functions written this way eventually complete because each rerun,
fewer lookups return <code>null</code>. With <code>SkyKeyComputeState</code> it is possible to
associate hand-specified check-point data with a SkyFunction, saving significant
recomputation.</p>
<p><code>StateMachine</code>s are objects that live inside <code>SkyKeyComputeState</code> and eliminate
virtually all recomputation when a SkyFunction restarts (assuming that
<code>SkyKeyComputeState</code> does not fall out of cache) by exposing suspend and resume
execution hooks.</p>
<h3 id="stateful-computations-inside-skykeycomputestate">Stateful computations inside <code>SkyKeyComputeState</code></h3>
<p>From an object-oriented design standpoint, it makes sense to consider storing
computational objects inside <code>SkyKeyComputeState</code> instead of pure data values.
In <em>Java</em>, the bare minimum description of a behavior carrying object is a
<em>functional interface</em> and it turns out to be sufficient. A <code>StateMachine</code> has
the following, curiously recursive, definition<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="err">@</span><span class="nx">FunctionalInterface</span>
</span></span><span class="line"><span class="cl"><span class="kr">public</span> <span class="kr">interface</span> <span class="nx">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">StateMachine</span> <span class="nx">step</span><span class="p">(</span><span class="nx">Tasks</span> <span class="nx">tasks</span><span class="p">)</span> <span class="kr">throws</span> <span class="nx">InterruptedException</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <code>Tasks</code> interface is analogous to <code>SkyFunction.Environment</code> but it is
designed for asynchrony and adds support for logically concurrent subtasks<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup>.</p>
<p>The return value of <code>step</code> is another <code>StateMachine</code>, allowing the specification
of a sequence of steps, inductively. <code>step</code> returns <code>DONE</code> when the
<code>StateMachine</code> is done. For example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HelloWorld</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;hello&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="p">::</span><span class="n">step2</span><span class="p">;</span>  <span class="o">//</span> <span class="n">The</span> <span class="nb">next</span> <span class="n">step</span> <span class="ow">is</span> <span class="n">HelloWorld</span><span class="o">.</span><span class="n">step2</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">step2</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&#34;world&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="o">//</span> <span class="n">DONE</span> <span class="ow">is</span> <span class="n">special</span> <span class="n">value</span> <span class="n">defined</span> <span class="ow">in</span> <span class="n">the</span> <span class="err">`</span><span class="n">StateMachine</span><span class="err">`</span> <span class="n">interface</span> <span class="n">signaling</span>
</span></span><span class="line"><span class="cl">     <span class="o">//</span> <span class="n">that</span> <span class="n">the</span> <span class="n">computation</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">     <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>describes a <code>StateMachine</code> with the following output.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">hello
</span></span><span class="line"><span class="cl">world
</span></span></code></pre></div><p>Note that the method reference <code>this::step2</code> is also a <code>StateMachine</code> due to
<code>step2</code> satisfying <code>StateMachine</code>&rsquo;s functional interface definition. Method
references are the most common way to specify the next state in a
<code>StateMachine</code>.</p>
<p><img src="/contribute/images/suspend-resume.svg" alt="Suspending and resuming"></p>
<p>Intuitively, breaking a computation down into <code>StateMachine</code> steps, instead of a
monolithic function, provides the hooks needed to <em>suspend</em> and <em>resume</em> a
computation. When <code>StateMachine.step</code> returns, there is an explicit <em>suspension</em>
point. The continuation specified by the returned <code>StateMachine</code> value is an
explicit <em>resume</em> point. Recomputation can thus be avoided because the
computation can be picked up exactly where it left off.</p>
<h3 id="callbacks-continuations-and-asynchronous-computation">Callbacks, continuations and asynchronous computation</h3>
<p>In technical terms, a <code>StateMachine</code> serves as a <em>continuation</em>, determining the
subsequent computation to be executed. Instead of blocking, a <code>StateMachine</code> can
voluntarily <em>suspend</em> by returning from the <code>step</code> function, which transfers
control back to a <a href="#drivers-and-bridging"><code>Driver</code></a> instance. The <code>Driver</code> can
then switch to a ready <code>StateMachine</code> or relinquish control back to Skyframe.</p>
<p>Traditionally, <em>callbacks</em> and <em>continuations</em> are conflated into one concept.
However, <code>StateMachine</code>s maintain a distinction between the two.</p>
<ul>
<li><em>Callback</em> - describes where to store the result of an asynchronous
computation.</li>
<li><em>Continuation</em> - specifies the next execution state.</li>
</ul>
<p>Callbacks are required when invoking an asynchronous operation, which means that
the actual operation doesn&rsquo;t occur immediately upon calling the method, as in
the case of a SkyValue lookup. Callbacks should be kept as simple as possible.</p>
<p>Caution: A common pitfall of callbacks is that the asynchronous computation must
ensure the callback is called by the end of every reachable path. It&rsquo;s possible
to overlook some branches and the compiler doesn&rsquo;t give warnings about this.</p>
<p><em>Continuations</em> are the <code>StateMachine</code> return values of <code>StateMachine</code>s and
encapsulate the complex execution that follows once all asynchronous
computations resolve. This structured approach helps to keep the complexity of
callbacks manageable.</p>
<h2 id="tasks">Tasks</h2>
<p>The <code>Tasks</code> interface provides <code>StateMachine</code>s with an API to lookup SkyValues
by SkyKey and to schedule concurrent subtasks.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">interface Tasks {
</span></span><span class="line"><span class="cl">  void enqueue(StateMachine subtask);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  void lookUp(SkyKey key, Consumer&lt;SkyValue&gt; sink);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  &lt;E extends Exception&gt;
</span></span><span class="line"><span class="cl">  void lookUp(SkyKey key, Class&lt;E&gt; exceptionClass, ValueOrExceptionSink&lt;E&gt; sink);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  // lookUp overloads for 2 and 3 exception types exist, but are elided here.
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>Tip: When any state uses the <code>Tasks</code> interface to perform lookups or create
subtasks, those lookups and subtasks will complete before the next state begins.</p>
<p>Tip: (Corollary) If subtasks are complex <code>StateMachine</code>s or recursively create
subtasks, they all <em>transitively</em> complete before the next state begins.</p>
<h3 id="skyvalue-lookups">SkyValue lookups</h3>
<p><code>StateMachine</code>s use <code>Tasks.lookUp</code> overloads to look up SkyValues. They are
analogous to <code>SkyFunction.Environment.getValue</code> and
<code>SkyFunction.Environment.getValueOrThrow</code> and have similar exception handling
semantics. The implementation does not immediately perform the lookup, but
instead, batches<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup> as many lookups as possible before doing so. The value
might not be immediately available, for example, requiring a Skyframe restart,
so the caller specifies what to do with the resulting value using a callback.</p>
<p>The <code>StateMachine</code> processor (<a href="#drivers-and-bridging"><code>Driver</code>s and bridging to
SkyFrame</a>) guarantees that the value is available before
the next state begins. An example follows.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">DoesLookup</span> <span class="n">implements</span> <span class="n">StateMachine</span><span class="p">,</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">SkyValue</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">Value</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span><span class="o">.</span><span class="n">lookUp</span><span class="p">(</span><span class="n">new</span> <span class="n">Key</span><span class="p">(),</span> <span class="p">(</span><span class="n">Consumer</span><span class="o">&lt;</span><span class="n">SkyValue</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="p">::</span><span class="n">processValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">The</span> <span class="err">`</span><span class="n">lookUp</span><span class="err">`</span> <span class="n">call</span> <span class="ow">in</span> <span class="err">`</span><span class="n">step</span><span class="err">`</span> <span class="n">causes</span> <span class="n">this</span> <span class="n">to</span> <span class="n">be</span> <span class="n">called</span> <span class="n">before</span> <span class="err">`</span><span class="n">processValue</span><span class="err">`</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>  <span class="o">//</span> <span class="n">Implementation</span> <span class="n">of</span> <span class="n">Consumer</span><span class="o">&lt;</span><span class="n">SkyValue</span><span class="o">&gt;.</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">void</span> <span class="n">accept</span><span class="p">(</span><span class="n">SkyValue</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">Value</span><span class="p">)</span><span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">processValue</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>  <span class="o">//</span> <span class="n">Prints</span> <span class="n">the</span> <span class="n">string</span> <span class="n">representation</span> <span class="n">of</span> <span class="err">`</span><span class="n">value</span><span class="err">`</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>In the above example, the first step does a lookup for <code>new Key()</code>, passing
<code>this</code> as the consumer. That is possible because <code>DoesLookup</code> implements
<code>Consumer&lt;SkyValue&gt;</code>.</p>
<p>Tip: When passing <code>this</code> as a value sink, it&rsquo;s helpful to readers to upcast it
to the receiver type to narrow down the purpose of passing <code>this</code>. The example
passes <code>(Consumer&lt;SkyValue&gt;) this</code>.</p>
<p>By contract, before the next state <code>DoesLookup.processValue</code> begins, all the
lookups of <code>DoesLookup.step</code> are complete. Therefore <code>value</code> is available when
it is accessed in <code>processValue</code>.</p>
<h3 id="subtasks">Subtasks</h3>
<p><code>Tasks.enqueue</code> requests the execution of logically concurrent subtasks.
Subtasks are also <code>StateMachine</code>s and can do anything regular <code>StateMachine</code>s
can do, including recursively creating more subtasks or looking up SkyValues.
Much like <code>lookUp</code>, the state machine driver ensures that all subtasks are
complete before proceeding to the next step. An example follows.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Subtasks</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">new</span> <span class="n">Subtask1</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">new</span> <span class="n">Subtask2</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">The</span> <span class="nb">next</span> <span class="n">step</span> <span class="ow">is</span> <span class="n">Subtasks</span><span class="o">.</span><span class="n">processResults</span><span class="o">.</span> <span class="n">It</span> <span class="n">won</span><span class="s1">&#39;t be called until both</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Subtask1</span> <span class="ow">and</span> <span class="n">Subtask</span> <span class="mi">2</span> <span class="n">are</span> <span class="n">complete</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="p">::</span><span class="n">processResults</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">processResults</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>  <span class="o">//</span> <span class="n">Prints</span> <span class="s2">&#34;3&#34;</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Subtasks</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="k">class</span> <span class="nc">Subtask1</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Subtask1</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="k">class</span> <span class="nc">Subtask2</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">    <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Subtask2</span> <span class="ow">is</span> <span class="n">done</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Though <code>Subtask1</code> and <code>Subtask2</code> are logically concurrent, everything runs in a
single thread so the &ldquo;concurrent&rdquo; update of <code>i</code> does not need any
synchronization.</p>
<h3 id="structured-concurrency">Structured concurrency</h3>
<p>Since every <code>lookUp</code> and <code>enqueue</code> must resolve before advancing to the next
state, it means that concurrency is naturally limited to tree-structures. It&rsquo;s
possible to create hierarchical<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup> concurrency as shown in the following
example.</p>
<p><img src="/contribute/images/structured-concurrency.svg" alt="Structured Concurrency"></p>
<p>It&rsquo;s hard to tell from the <em>UML</em> that the concurrency structure forms a tree.
There&rsquo;s an <a href="#concurrency-tree-diagram">alternate view</a> that better shows the
tree structure.</p>
<p><img src="/contribute/images/unstructured-concurrency.svg" alt="Unstructured Concurrency"></p>
<p>Structured concurrency is much easier to reason about.</p>
<h2 id="composition-and-control-flow-patterns">Composition and control flow patterns</h2>
<p>This section presents examples for how multiple <code>StateMachine</code>s can be composed
and solutions to certain control flow problems.</p>
<h3 id="sequential-states">Sequential states</h3>
<p>This is the most common and straightforward control flow pattern. An example of
this is shown in <a href="#stateful-computations">Stateful computations inside
<code>SkyKeyComputeState</code></a>.</p>
<h3 id="branching">Branching</h3>
<p>Branching states in <code>StateMachine</code>s can be achieved by returning different
values using regular <em>Java</em> control flow, as shown in the following example.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Branch</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Returns</span> <span class="n">different</span> <span class="n">state</span> <span class="n">machines</span><span class="p">,</span> <span class="n">depending</span> <span class="n">on</span> <span class="n">condition</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">shouldUseA</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">this</span><span class="p">::</span><span class="n">performA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="p">::</span><span class="n">performB</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="err"></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Its very common for certain branches to return <code>DONE</code>, for early completion.</p>
<h3 id="advanced-sequential-composition">Advanced sequential composition</h3>
<p>Since the <code>StateMachine</code> control structure is memoryless, sharing <code>StateMachine</code>
definitions as subtasks can sometimes be awkward. Let <em>M<sub>1</sub></em> and
<em>M<sub>2</sub></em> be <code>StateMachine</code> instances that share a <code>StateMachine</code>, <em>S</em>,
with <em>M<sub>1</sub></em> and <em>M<sub>2</sub></em> being the sequences <em>&lt;A, S, B&gt;</em> and
<em>&lt;X, S, Y&gt;</em> respectively. The problem is that <em>S</em> doesnt know whether to
continue to <em>B</em> or <em>Y</em> after it completes and <code>StateMachine</code>s don&rsquo;t quite keep a
call stack. This section reviews some techniques for achieving this.</p>
<h4 id="statemachine-as-terminal-sequence-element"><code>StateMachine</code> as terminal sequence element</h4>
<p>This doesnt solve the initial problem posed. It only demonstrates sequential
composition when the shared <code>StateMachine</code> is terminal in the sequence.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">// S is the shared state machine.
</span></span><span class="line"><span class="cl">class S implements StateMachine {  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class M1 implements StateMachine {
</span></span><span class="line"><span class="cl">  @Override
</span></span><span class="line"><span class="cl">  public StateMachine step(Tasks tasks) {
</span></span><span class="line"><span class="cl">    performA();
</span></span><span class="line"><span class="cl">    return new S();
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class M2 implements StateMachine {
</span></span><span class="line"><span class="cl">  @Override
</span></span><span class="line"><span class="cl">  public StateMachine step(Tasks tasks) {
</span></span><span class="line"><span class="cl">    performX();
</span></span><span class="line"><span class="cl">    return new S();
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>This works even if <em>S</em> is itself a complex state machine.</p>
<h4 id="subtask-for-sequential-composition">Subtask for sequential composition</h4>
<p>Since enqueued subtasks are guaranteed to complete before the next state, its
sometimes possible to slightly abuse<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup> the subtask mechanism.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">M1</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">performA</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">S</span> <span class="n">starts</span> <span class="n">after</span> <span class="err">`</span><span class="n">step</span><span class="err">`</span> <span class="n">returns</span> <span class="ow">and</span> <span class="n">by</span> <span class="n">contract</span> <span class="n">must</span> <span class="n">complete</span> <span class="n">before</span> <span class="err">`</span><span class="n">doB</span><span class="err">`</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">begins</span><span class="o">.</span> <span class="n">It</span> <span class="ow">is</span> <span class="n">effectively</span> <span class="n">sequential</span><span class="p">,</span> <span class="n">inducing</span> <span class="n">the</span> <span class="n">sequence</span> <span class="o">&lt;</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">B</span> <span class="o">&gt;.</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">new</span> <span class="n">S</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="p">::</span><span class="n">doB</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">doB</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">performB</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">M2</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">performX</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Similarly</span><span class="p">,</span> <span class="n">this</span> <span class="n">induces</span> <span class="n">the</span> <span class="n">sequence</span> <span class="o">&lt;</span> <span class="n">X</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">Y</span><span class="o">&gt;.</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">new</span> <span class="n">S</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="p">::</span><span class="n">doY</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">doY</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">performY</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="runafter-injection"><code>runAfter</code> injection</h4>
<p>Sometimes, abusing <code>Tasks.enqueue</code> is impossible because there are other
parallel subtasks or <code>Tasks.lookUp</code> calls that must be completed before <em>S</em>
executes. In this case, injecting a <code>runAfter</code> parameter into <em>S</em> can be used to
inform <em>S</em> of what to do next.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">S</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">Specifies</span> <span class="n">what</span> <span class="n">to</span> <span class="n">run</span> <span class="n">after</span> <span class="n">S</span> <span class="n">completes</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">final</span> <span class="n">StateMachine</span> <span class="n">runAfter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err"></span> <span class="o">//</span> <span class="n">Performs</span> <span class="n">some</span> <span class="n">computations</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="p">::</span><span class="n">processResults</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Nullable</span>
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">processResults</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err"></span> <span class="o">//</span> <span class="n">Does</span> <span class="n">some</span> <span class="n">additional</span> <span class="n">processing</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Executes</span> <span class="n">the</span> <span class="n">state</span> <span class="n">machine</span> <span class="n">defined</span> <span class="n">by</span> <span class="err">`</span><span class="n">runAfter</span><span class="err">`</span> <span class="n">after</span> <span class="n">S</span> <span class="n">completes</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">runAfter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">M1</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">performA</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Passes</span> <span class="err">`</span><span class="n">this</span><span class="p">::</span><span class="n">doB</span><span class="err">`</span> <span class="k">as</span> <span class="n">the</span> <span class="err">`</span><span class="n">runAfter</span><span class="err">`</span> <span class="n">parameter</span> <span class="n">of</span> <span class="n">S</span><span class="p">,</span> <span class="n">resulting</span> <span class="ow">in</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">sequence</span> <span class="o">&lt;</span> <span class="n">A</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">B</span> <span class="o">&gt;.</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new</span> <span class="n">S</span><span class="p">(</span><span class="o">/*</span> <span class="n">runAfter</span><span class="o">=</span> <span class="o">*/</span> <span class="n">this</span><span class="p">::</span><span class="n">doB</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">doB</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">performB</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">M2</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">performX</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Passes</span> <span class="err">`</span><span class="n">this</span><span class="p">::</span><span class="n">doY</span><span class="err">`</span> <span class="k">as</span> <span class="n">the</span> <span class="err">`</span><span class="n">runAfter</span><span class="err">`</span> <span class="n">parameter</span> <span class="n">of</span> <span class="n">S</span><span class="p">,</span> <span class="n">resulting</span> <span class="ow">in</span> <span class="n">the</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">sequence</span> <span class="o">&lt;</span> <span class="n">X</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">Y</span> <span class="o">&gt;.</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new</span> <span class="n">S</span><span class="p">(</span><span class="o">/*</span> <span class="n">runAfter</span><span class="o">=</span> <span class="o">*/</span> <span class="n">this</span><span class="p">::</span><span class="n">doY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">doY</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">performY</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This approach is cleaner than abusing subtasks. However, applying this too
liberally, for example, by nesting multiple <code>StateMachine</code>s with <code>runAfter</code>, is
the road to <a href="#callback-hell">Callback Hell</a>. Its better to break up sequential
<code>runAfter</code>s with ordinary sequential states instead.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">  return new S(/* runAfter= */ new T(/* runAfter= */ this::nextStep))
</span></span></code></pre></div><p>can be replaced with the following.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">  private StateMachine step1(Tasks tasks) {
</span></span><span class="line"><span class="cl">     doStep1();
</span></span><span class="line"><span class="cl">     return new S(/* runAfter= */ this::intermediateStep);
</span></span><span class="line"><span class="cl">  }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  private StateMachine intermediateStep(Tasks tasks) {
</span></span><span class="line"><span class="cl">    return new T(/* runAfter= */ this::nextStep);
</span></span><span class="line"><span class="cl">  }
</span></span></code></pre></div><p>Note: It&rsquo;s possible to pass <code>DONE</code> as the <code>runAfter</code> parameter when there&rsquo;s
nothing to run afterwards.</p>
<p>Tip: When using <code>runAfter</code>, always annotate the parameter with <code>/* runAfter= */</code>
to let the reader know the meaning at the callsite.</p>
<h4 id="forbidden-alternative-runafterunlesserror"><em>Forbidden</em> alternative: <code>runAfterUnlessError</code></h4>
<p>In an earlier draft, we had considered a <code>runAfterUnlessError</code> that would abort
early on errors. This was motivated by the fact that errors often end up getting
checked twice, once by the <code>StateMachine</code> that has a <code>runAfter</code> reference and
once by the <code>runAfter</code> machine itself.</p>
<p>After some deliberation, we decided that uniformity of the code is more
important than deduplicating the error checking. It would be confusing if the
<code>runAfter</code> mechanism did not work in a consistent manner with the
<code>tasks.enqueue</code> mechanism, which always requires error checking.</p>
<p>Warning: When using <code>runAfter</code>, the machine that has the injected <code>runAfter</code>
should invoke it unconditionally at completion, even on error, for consistency.</p>
<h3 id="direct-delegation">Direct delegation</h3>
<p>Each time there is a formal state transition, the main <code>Driver</code> loop advances.
As per contract, advancing states means that all previously enqueued SkyValue
lookups and subtasks resolve before the next state executes. Sometimes the logic
of a delegate <code>StateMachine</code> makes a phase advance unnecessary or
counterproductive. For example, if the first <code>step</code> of the delegate performs
SkyKey lookups that could be parallelized with lookups of the delegating state
then a phase advance would make them sequential. It could make more sense to
perform direct delegation, as shown in the example below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Parent</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span><span class="o">.</span><span class="n">lookUp</span><span class="p">(</span><span class="n">new</span> <span class="n">Key1</span><span class="p">(),</span> <span class="n">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Directly</span> <span class="n">delegates</span> <span class="n">to</span> <span class="err">`</span><span class="n">Delegate</span><span class="err">`</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">The</span> <span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="n">alternative</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span>   <span class="k">return</span> <span class="n">new</span> <span class="n">Delegate</span><span class="p">(</span><span class="n">this</span><span class="p">::</span><span class="n">afterDelegation</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">would</span> <span class="n">cause</span> <span class="err">`</span><span class="n">Delegate</span><span class="o">.</span><span class="n">step</span><span class="err">`</span> <span class="n">to</span> <span class="n">execute</span> <span class="n">after</span> <span class="err">`</span><span class="n">step</span><span class="err">`</span> <span class="n">completes</span> <span class="n">which</span> <span class="n">would</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">cause</span> <span class="n">lookups</span> <span class="n">of</span> <span class="err">`</span><span class="n">Key1</span><span class="err">`</span> <span class="ow">and</span> <span class="err">`</span><span class="n">Key2</span><span class="err">`</span> <span class="n">to</span> <span class="n">be</span> <span class="n">sequential</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">parallel</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">new</span> <span class="n">Delegate</span><span class="p">(</span><span class="n">this</span><span class="p">::</span><span class="n">afterDelegation</span><span class="p">)</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">tasks</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">afterDelegation</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err"></span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Delegate</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">final</span> <span class="n">StateMachine</span> <span class="n">runAfter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Delegate</span><span class="p">(</span><span class="n">StateMachine</span> <span class="n">runAfter</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">runAfter</span> <span class="o">=</span> <span class="n">runAfter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span><span class="o">.</span><span class="n">lookUp</span><span class="p">(</span><span class="n">new</span> <span class="n">Key2</span><span class="p">(),</span> <span class="n">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="err"></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">Rest</span> <span class="n">of</span> <span class="n">implementation</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="err"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">complete</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err"></span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">runAfter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="data-flow">Data flow</h2>
<p>The focus of the previous discussion has been on managing control flow. This
section describes the propagation of data values.</p>
<h3 id="implementing-taskslookup-callbacks">Implementing <code>Tasks.lookUp</code> callbacks</h3>
<p>Theres an example of implementing a <code>Tasks.lookUp</code> callback in <a href="#skyvalue-lookups">SkyValue
lookups</a>. This section provides rationale and suggests
approaches for handling multiple SkyValues.</p>
<h4 id="taskslookup-callbacks"><code>Tasks.lookUp</code> callbacks</h4>
<p>The <code>Tasks.lookUp</code> method takes a callback, <code>sink</code>, as a parameter.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">  void lookUp(SkyKey key, Consumer&lt;SkyValue&gt; sink);
</span></span></code></pre></div><p>The idiomatic approach would be to use a <em>Java</em> lambda to implement this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">  tasks.lookUp(key, value -&gt; myValue = (MyValueClass)value);
</span></span></code></pre></div><p>with <code>myValue</code> being a member variable of the <code>StateMachine</code> instance doing the
lookup. However, the lambda requires an extra memory allocation compared to
implementing the <code>Consumer&lt;SkyValue&gt;</code> interface in the <code>StateMachine</code>
implementation. The lambda is still useful when there are multiple lookups that
would be ambiguous.</p>
<p>Note: Bikeshed warning. There is a noticeable difference of approximately 1%
end-to-end CPU usage when implementing callbacks systematically in
<code>StateMachine</code> implementations compared to using lambdas, which makes this
recommendation debatable. To avoid unnecessary debates, it is advised to leave
the decision up to the individual implementing the solution.</p>
<p>There are also error handling overloads of <code>Tasks.lookUp</code>, that are analogous to
<code>SkyFunction.Environment.getValueOrThrow</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">  &lt;E extends Exception&gt; void lookUp(
</span></span><span class="line"><span class="cl">      SkyKey key, Class&lt;E&gt; exceptionClass, ValueOrExceptionSink&lt;E&gt; sink);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  interface ValueOrExceptionSink&lt;E extends Exception&gt; {
</span></span><span class="line"><span class="cl">    void acceptValueOrException(@Nullable SkyValue value, @Nullable E exception);
</span></span><span class="line"><span class="cl">  }
</span></span></code></pre></div><p>An example implementation is shown below.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">PerformLookupWithError</span> <span class="n">extends</span> <span class="n">StateMachine</span><span class="p">,</span> <span class="n">ValueOrExceptionSink</span><span class="o">&lt;</span><span class="n">MyException</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">MyValue</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">MyException</span> <span class="n">error</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span><span class="o">.</span><span class="n">lookUp</span><span class="p">(</span><span class="n">new</span> <span class="n">MyKey</span><span class="p">(),</span> <span class="n">MyException</span><span class="o">.</span><span class="n">class</span><span class="p">,</span> <span class="n">ValueOrExceptionSink</span><span class="o">&lt;</span><span class="n">MyException</span><span class="o">&gt;</span><span class="p">)</span> <span class="n">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="p">::</span><span class="n">processResult</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">acceptValueOrException</span><span class="p">(</span><span class="nd">@Nullable</span> <span class="n">SkyValue</span> <span class="n">value</span><span class="p">,</span> <span class="nd">@Nullable</span> <span class="n">MyException</span> <span class="n">exception</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">this</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">MyValue</span><span class="p">)</span><span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">this</span><span class="o">.</span><span class="n">error</span> <span class="o">=</span> <span class="n">exception</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">throw</span> <span class="n">new</span> <span class="n">IllegalArgumentException</span><span class="p">(</span><span class="s2">&#34;Both parameters were unexpectedly null.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">processResult</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">exception</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="o">//</span> <span class="n">Handles</span> <span class="n">the</span> <span class="n">error</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">      <span class="err"></span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Processes</span> <span class="err">`</span><span class="n">value</span><span class="err">`</span><span class="p">,</span> <span class="n">which</span> <span class="ow">is</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="err"></span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>As with lookups without error handling, having the <code>StateMachine</code> class directly
implement the callback saves a memory allocation for the lamba.</p>
<p><a href="#error-handling">Error handling</a> provides a bit more detail, but essentially,
there&rsquo;s not much difference between the propagation of errors and normal values.</p>
<h4 id="consuming-multiple-skyvalues">Consuming multiple SkyValues</h4>
<p>Multiple SkyValue lookups are often required. An approach that works much of the
time is to switch on the type of SkyValue. The following is an example that has
been simplified from prototype production code.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl">  <span class="err">@</span><span class="nx">Nullable</span>
</span></span><span class="line"><span class="cl">  <span class="kr">private</span> <span class="nx">StateMachine</span> <span class="nx">fetchConfigurationAndPackage</span><span class="p">(</span><span class="nx">Tasks</span> <span class="nx">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">configurationKey</span> <span class="o">=</span> <span class="nx">configuredTarget</span><span class="p">.</span><span class="nx">getConfigurationKey</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">configurationKey</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">tasks</span><span class="p">.</span><span class="nx">lookUp</span><span class="p">(</span><span class="nx">configurationKey</span><span class="p">,</span> <span class="p">(</span><span class="nx">Consumer</span><span class="o">&lt;</span><span class="nx">SkyValue</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">packageId</span> <span class="o">=</span> <span class="nx">configuredTarget</span><span class="p">.</span><span class="nx">getLabel</span><span class="p">().</span><span class="nx">getPackageIdentifier</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="nx">tasks</span><span class="p">.</span><span class="nx">lookUp</span><span class="p">(</span><span class="nx">PackageValue</span><span class="p">.</span><span class="nx">key</span><span class="p">(</span><span class="nx">packageId</span><span class="p">),</span> <span class="p">(</span><span class="nx">Consumer</span><span class="o">&lt;</span><span class="nx">SkyValue</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="k">this</span><span class="o">::</span><span class="nx">constructResult</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="nx">Override</span>  <span class="c1">// Implementation of `Consumer&lt;SkyValue&gt;`.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kr">public</span> <span class="k">void</span> <span class="nx">accept</span><span class="p">(</span><span class="nx">SkyValue</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">BuildConfigurationValue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">configurationValue</span> <span class="o">=</span> <span class="p">(</span><span class="nx">BuildConfigurationValue</span><span class="p">)</span> <span class="nx">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="k">instanceof</span> <span class="nx">PackageValue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="p">.</span><span class="nx">pkg</span> <span class="o">=</span> <span class="p">((</span><span class="nx">PackageValue</span><span class="p">)</span> <span class="nx">value</span><span class="p">).</span><span class="nx">getPackage</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">throw</span> <span class="k">new</span> <span class="nx">IllegalArgumentException</span><span class="p">(</span><span class="s2">&#34;unexpected value: &#34;</span> <span class="o">+</span> <span class="nx">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><p>The <code>Consumer&lt;SkyValue&gt;</code> callback implementation can be shared unambiguously
because the value types are different. When thats not the case, falling back to
lambda-based implementations or full inner-class instances that implement the
appropriate callbacks is viable.</p>
<h3 id="propagating-values-between-statemachines">Propagating values between <code>StateMachine</code>s</h3>
<p>So far, this document has only explained how to arrange work in a subtask, but
subtasks also need to report a values back to the caller. Since subtasks are
logically asynchronous, their results are communicated back to the caller using
a <em>callback</em>. To make this work, the subtask defines a sink interface that is
injected via its constructor.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">BarProducer</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">Callers</span> <span class="n">of</span> <span class="n">BarProducer</span> <span class="n">implement</span> <span class="n">the</span> <span class="n">following</span> <span class="n">interface</span> <span class="n">to</span> <span class="n">accept</span> <span class="n">its</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">results</span><span class="o">.</span> <span class="n">Exactly</span> <span class="n">one</span> <span class="n">of</span> <span class="n">the</span> <span class="n">two</span> <span class="n">methods</span> <span class="n">will</span> <span class="n">be</span> <span class="n">called</span> <span class="n">by</span> <span class="n">the</span> <span class="n">time</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">BarProducer</span> <span class="n">completes</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="n">interface</span> <span class="n">ResultSink</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">void</span> <span class="n">acceptBarValue</span><span class="p">(</span><span class="n">Bar</span> <span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">void</span> <span class="n">acceptBarError</span><span class="p">(</span><span class="n">BarException</span> <span class="n">exception</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">final</span> <span class="n">ResultSink</span> <span class="n">sink</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">BarProducer</span><span class="p">(</span><span class="n">ResultSink</span> <span class="n">sink</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="n">this</span><span class="o">.</span><span class="n">sink</span> <span class="o">=</span> <span class="n">sink</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err"></span> <span class="o">//</span> <span class="n">StateMachine</span> <span class="n">steps</span> <span class="n">that</span> <span class="n">end</span> <span class="k">with</span> <span class="n">this</span><span class="p">::</span><span class="n">complete</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">complete</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hasError</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">sink</span><span class="o">.</span><span class="n">acceptBarError</span><span class="p">(</span><span class="n">getError</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">sink</span><span class="o">.</span><span class="n">acceptBarValue</span><span class="p">(</span><span class="n">getValue</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Tip: It would be tempting to use the more concise signature void <code>accept(Bar value)</code> rather than the stuttery <code>void acceptBarValue(Bar value)</code> above.
However, <code>Consumer&lt;SkyValue&gt;</code> is a common overload of <code>void accept(Bar value)</code>,
so doing this often leads to violations of the <a href="https://google.github.io/styleguide/javaguide.html#s3.4.2-ordering-class-contents">Overloads: never
split</a>
style-guide rule.</p>
<p>Tip: Using a custom <code>ResultSink</code> type instead of a generic one from
<code>java.util.function</code> makes it easy to find implementations in the code base,
improving readability.</p>
<p>A caller <code>StateMachine</code> would then look like the following.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Caller</span> <span class="n">implements</span> <span class="n">StateMachine</span><span class="p">,</span> <span class="n">BarProducer</span><span class="o">.</span><span class="n">ResultSink</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">interface</span> <span class="n">ResultSink</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">void</span> <span class="n">acceptCallerValue</span><span class="p">(</span><span class="n">Bar</span> <span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">void</span> <span class="n">acceptCallerError</span><span class="p">(</span><span class="n">BarException</span> <span class="n">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">final</span> <span class="n">ResultSink</span> <span class="n">sink</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">Bar</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Caller</span><span class="p">(</span><span class="n">ResultSink</span> <span class="n">sink</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">sink</span> <span class="o">=</span> <span class="n">sink</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Nullable</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">tasks</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="n">new</span> <span class="n">BarProducer</span><span class="p">((</span><span class="n">BarProducer</span><span class="o">.</span><span class="n">ResultSink</span><span class="p">)</span> <span class="n">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="p">::</span><span class="n">processResult</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">void</span> <span class="n">acceptBarValue</span><span class="p">(</span><span class="n">Bar</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">void</span> <span class="n">acceptBarError</span><span class="p">(</span><span class="n">BarException</span> <span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sink</span><span class="o">.</span><span class="n">acceptCallerError</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">processResult</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">Since</span> <span class="nb">all</span> <span class="n">enqueued</span> <span class="n">subtasks</span> <span class="n">resolve</span> <span class="n">before</span> <span class="err">`</span><span class="n">processResult</span><span class="err">`</span> <span class="n">starts</span><span class="p">,</span> <span class="n">one</span> <span class="n">of</span>
</span></span><span class="line"><span class="cl">    <span class="o">//</span> <span class="n">the</span> <span class="err">`</span><span class="n">BarResultSink</span><span class="err">`</span> <span class="n">callbacks</span> <span class="n">must</span> <span class="n">have</span> <span class="n">been</span> <span class="n">called</span> <span class="n">by</span> <span class="n">this</span> <span class="n">point</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>  <span class="o">//</span> <span class="n">There</span> <span class="n">was</span> <span class="n">a</span> <span class="n">previously</span> <span class="n">reported</span> <span class="n">error</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">var</span> <span class="n">finalResult</span> <span class="o">=</span> <span class="n">computeResult</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">sink</span><span class="o">.</span><span class="n">acceptCallerValue</span><span class="p">(</span><span class="n">finalResult</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The preceding example demonstrates a few things. <code>Caller</code> has to propagate its
results back and defines its own <code>Caller.ResultSink</code>. <code>Caller</code> implements the
<code>BarProducer.ResultSink</code> callbacks. Upon resumption, <code>processResult</code> checks if
<code>value</code> is null to determine if an error occurred. This is a common behavior
pattern after accepting output from either a subtask or SkyValue lookup.</p>
<p>Note that the implementation of <code>acceptBarError</code> eagerly forwards the result to
the <code>Caller.ResultSink</code>, as required by <a href="#error-bubbling">Error bubbling</a>.</p>
<p>Alternatives for top-level <code>StateMachine</code>s are described in <a href="#drivers-and-bridging"><code>Driver</code>s and
bridging to SkyFunctions</a>.</p>
<h3 id="error-handling">Error handling</h3>
<p>There&rsquo;s a couple of examples of error handling already in <a href="#tasks-lookup-callbacks"><code>Tasks.lookUp</code>
callbacks</a> and <a href="#propagating-values">Propagating values between
<code>StateMachines</code></a>. Exceptions, other than
<code>InterruptedException</code> are not thrown, but instead passed around through
callbacks as values. Such callbacks often have exclusive-or semantics, with
exactly one of a value or error being passed.</p>
<p>The next section describes a a subtle, but important interaction with Skyframe
error handling.</p>
<h4 id="error-bubbling-nokeep_going">Error bubbling (&ndash;nokeep_going)</h4>
<p>Warning: Errors need to be eagerly propagated all the way back to the
SkyFunction for error bubbling to function correctly.</p>
<p>During error bubbling, a SkyFunction may be restarted even if not all requested
SkyValues are available. In such cases, the subsequent state will never be
reached due to the <code>Tasks</code> API contract. However, the <code>StateMachine</code> should
still propagate the exception.</p>
<p>Since propagation must occur regardless of whether the next state is reached,
the error handling callback must perform this task. For an inner <code>StateMachine</code>,
this is achieved by invoking the parent callback.</p>
<p>At the top-level <code>StateMachine</code>, which interfaces with the SkyFunction, this can
be done by calling the <code>setException</code> method of <code>ValueOrExceptionProducer</code>.
<code>ValueOrExceptionProducer.tryProduceValue</code> will then throw the exception, even
if there are missing SkyValues.</p>
<p>If a <code>Driver</code> is being utilized directly, it is essential to check for
propagated errors from the SkyFunction, even if the machine has not finished
processing.</p>
<h3 id="event-handling">Event Handling</h3>
<p>For SkyFunctions that need to emit events, a <code>StoredEventHandler</code> is injected
into SkyKeyComputeState and further injected into <code>StateMachine</code>s that require
them. Historically, the <code>StoredEventHandler</code> was needed due to Skyframe dropping
certain events unless they are replayed but this was subsequently fixed.
<code>StoredEventHandler</code> injection is preserved because it simplifies the
implementation of events emitted from error handling callbacks.</p>
<h2 id="drivers-and-bridging-to-skyfunctions"><code>Driver</code>s and bridging to SkyFunctions</h2>
<p>A <code>Driver</code> is responsible for managing the execution of <code>StateMachine</code>s,
beginning with a specified root <code>StateMachine</code>. As <code>StateMachine</code>s can
recursively enqueue subtask <code>StateMachine</code>s, a single <code>Driver</code> can manage
numerous subtasks. These subtasks create a tree structure, a result of
<a href="#structured-concurrency">Structured concurrency</a>. The <code>Driver</code> batches SkyValue
lookups across subtasks for improved efficiency.</p>
<p>There are a number of classes built around the <code>Driver</code>, with the following API.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">public</span> <span class="n">final</span> <span class="k">class</span> <span class="nc">Driver</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">Driver</span><span class="p">(</span><span class="n">StateMachine</span> <span class="n">root</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">boolean</span> <span class="n">drive</span><span class="p">(</span><span class="n">SkyFunction</span><span class="o">.</span><span class="n">Environment</span> <span class="n">env</span><span class="p">)</span> <span class="n">throws</span> <span class="n">InterruptedException</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><code>Driver</code> takes a single root <code>StateMachine</code> as a parameter. Calling
<code>Driver.drive</code> executes the <code>StateMachine</code> as far as it can go without a
Skyframe restart. It returns true when the <code>StateMachine</code> completes and false
otherwise, indicating that not all values were available.</p>
<p><code>Driver</code> maintains the concurrent state of the <code>StateMachine</code> and it is well
suited for embedding in <code>SkyKeyComputeState</code>.</p>
<h3 id="directly-instantiating-driver">Directly instantiating <code>Driver</code></h3>
<p><code>StateMachine</code> implementations conventionally communicate their results via
callbacks. It&rsquo;s possible to directly instantiate a <code>Driver</code> as shown in the
following example.</p>
<p>The <code>Driver</code> is embedded in the <code>SkyKeyComputeState</code> implementation along with
an implementation of the corresponding <code>ResultSink</code> to be defined a bit further
down. At the top level, the <code>State</code> object is an appropriate receiver for the
result of the computation as it is guaranteed to outlive <code>Driver</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">State</span> <span class="n">implements</span> <span class="n">SkyKeyComputeState</span><span class="p">,</span> <span class="n">ResultProducer</span><span class="o">.</span><span class="n">ResultSink</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">The</span> <span class="err">`</span><span class="n">Driver</span><span class="err">`</span> <span class="n">instance</span><span class="p">,</span> <span class="n">containing</span> <span class="n">the</span> <span class="n">full</span> <span class="n">tree</span> <span class="n">of</span> <span class="nb">all</span> <span class="err">`</span><span class="n">StateMachine</span><span class="err">`</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">states</span><span class="o">.</span> <span class="n">Responsible</span> <span class="k">for</span> <span class="n">calling</span> <span class="err">`</span><span class="n">StateMachine</span><span class="o">.</span><span class="n">step</span><span class="err">`</span> <span class="n">implementations</span> <span class="n">when</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">asynchronous</span> <span class="n">values</span> <span class="n">are</span> <span class="n">available</span> <span class="ow">and</span> <span class="n">performing</span> <span class="n">batched</span> <span class="n">SkyFrame</span> <span class="n">lookups</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">Non</span><span class="o">-</span><span class="n">null</span> <span class="k">while</span> <span class="err">`</span><span class="n">result</span><span class="err">`</span> <span class="ow">is</span> <span class="n">being</span> <span class="n">computed</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">Driver</span> <span class="n">resultProducer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">Variable</span> <span class="k">for</span> <span class="n">storing</span> <span class="n">the</span> <span class="n">result</span> <span class="n">of</span> <span class="n">the</span> <span class="err">`</span><span class="n">StateMachine</span><span class="err">`</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">Will</span> <span class="n">be</span> <span class="n">non</span><span class="o">-</span><span class="n">null</span> <span class="n">after</span> <span class="n">the</span> <span class="n">computation</span> <span class="n">completes</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span>
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">ResultType</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">Implements</span> <span class="err">`</span><span class="n">ResultProducer</span><span class="o">.</span><span class="n">ResultSink</span><span class="err">`</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="err">`</span><span class="n">ResultProducer</span><span class="err">`</span> <span class="n">propagates</span> <span class="n">its</span> <span class="n">final</span> <span class="n">value</span> <span class="n">through</span> <span class="n">a</span> <span class="n">callback</span> <span class="n">that</span> <span class="ow">is</span>
</span></span><span class="line"><span class="cl">  <span class="o">//</span> <span class="n">implemented</span> <span class="n">here</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">void</span> <span class="n">acceptResult</span><span class="p">(</span><span class="n">ResultType</span> <span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The code below sketches the <code>ResultProducer</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ResultProducer</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">interface</span> <span class="n">ResultSink</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">void</span> <span class="n">acceptResult</span><span class="p">(</span><span class="n">ResultType</span> <span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">final</span> <span class="n">Parameters</span> <span class="n">parameters</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">final</span> <span class="n">ResultSink</span> <span class="n">sink</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err"></span> <span class="o">//</span> <span class="n">Other</span> <span class="n">internal</span> <span class="n">state</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ResultProducer</span><span class="p">(</span><span class="n">Parameters</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">ResultSink</span> <span class="n">sink</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">sink</span> <span class="o">=</span> <span class="n">sink</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err"></span>  <span class="o">//</span> <span class="n">Implementation</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="p">::</span><span class="n">complete</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">complete</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">sink</span><span class="o">.</span><span class="n">acceptResult</span><span class="p">(</span><span class="n">getResult</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Then the code for lazily computing the result could look like the following.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="err">@</span><span class="nx">Nullable</span>
</span></span><span class="line"><span class="cl"><span class="kr">private</span> <span class="nx">Result</span> <span class="nx">computeResult</span><span class="p">(</span><span class="nx">State</span> <span class="nx">state</span><span class="p">,</span> <span class="nx">Skyfunction</span><span class="p">.</span><span class="nx">Environment</span> <span class="nx">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">throws</span> <span class="nx">InterruptedException</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">state</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">resultProducer</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">state</span><span class="p">.</span><span class="nx">resultProducer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Driver</span><span class="p">(</span><span class="k">new</span> <span class="nx">ResultProducer</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="k">new</span> <span class="nx">Parameters</span><span class="p">(),</span> <span class="p">(</span><span class="nx">ResultProducer</span><span class="p">.</span><span class="nx">ResultSink</span><span class="p">)</span><span class="nx">state</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">resultProducer</span><span class="p">.</span><span class="nx">drive</span><span class="p">(</span><span class="nx">env</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Clears the `Driver` instance as it is no longer needed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="nx">state</span><span class="p">.</span><span class="nx">resultProducer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">state</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="embedding-driver">Embedding <code>Driver</code></h3>
<p>If the <code>StateMachine</code> produces a value and raises no exceptions, embedding
<code>Driver</code> is another possible implementation, as shown in the following example.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ResultProducer</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">final</span> <span class="n">Parameters</span> <span class="n">parameters</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">final</span> <span class="n">Driver</span> <span class="n">driver</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">ResultType</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">ResultProducer</span><span class="p">(</span><span class="n">Parameters</span> <span class="n">parameters</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">this</span><span class="o">.</span><span class="n">driver</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Driver</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Nullable</span>  <span class="o">//</span> <span class="n">Null</span> <span class="n">when</span> <span class="n">a</span> <span class="n">Skyframe</span> <span class="n">restart</span> <span class="ow">is</span> <span class="n">needed</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">ResultType</span> <span class="n">tryProduceValue</span><span class="p">(</span> <span class="n">SkyFunction</span><span class="o">.</span><span class="n">Environment</span> <span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="err">!</span><span class="n">driver</span><span class="o">.</span><span class="n">drive</span><span class="p">(</span><span class="n">env</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err"></span>  <span class="o">//</span> <span class="n">Implementation</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The SkyFunction may have code that looks like the following (where <code>State</code> is
the function specific type of <code>SkyKeyComputeState</code>).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="err">@</span><span class="nx">Nullable</span>  <span class="c1">// Null when a Skyframe restart is needed.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">Result</span> <span class="nx">computeResult</span><span class="p">(</span><span class="nx">SkyFunction</span><span class="p">.</span><span class="nx">Environment</span> <span class="nx">env</span><span class="p">,</span> <span class="nx">State</span> <span class="nx">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="kr">throws</span> <span class="nx">InterruptedException</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">result</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">state</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">state</span><span class="p">.</span><span class="nx">resultProducer</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">state</span><span class="p">.</span><span class="nx">resultProducer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ResultProducer</span><span class="p">(</span><span class="k">new</span> <span class="nx">Parameters</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">resultProducer</span><span class="p">.</span><span class="nx">tryProduceValue</span><span class="p">(</span><span class="nx">env</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="nx">state</span><span class="p">.</span><span class="nx">resultProducer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">state</span><span class="p">.</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Embedding <code>Driver</code> in the <code>StateMachine</code> implementation is a better fit for
Skyframe&rsquo;s synchronous coding style.</p>
<h3 id="statemachines-that-may-produce-exceptions">StateMachines that may produce exceptions</h3>
<p>Otherwise, there are <code>SkyKeyComputeState</code>-embeddable <code>ValueOrExceptionProducer</code>
and <code>ValueOrException2Producer</code> classes that have synchronous APIs to match
synchronous SkyFunction code.</p>
<p>The <code>ValueOrExceptionProducer</code> abstract class includes the following methods.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">public</span> <span class="n">abstract</span> <span class="k">class</span> <span class="nc">ValueOrExceptionProducer</span><span class="o">&lt;</span><span class="n">V</span><span class="p">,</span> <span class="n">E</span> <span class="n">extends</span> <span class="ne">Exception</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Nullable</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">final</span> <span class="n">V</span> <span class="n">tryProduceValue</span><span class="p">(</span><span class="n">Environment</span> <span class="n">env</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">throws</span> <span class="n">InterruptedException</span><span class="p">,</span> <span class="n">E</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="err"></span>  <span class="o">//</span> <span class="n">Implementation</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">protected</span> <span class="n">final</span> <span class="n">void</span> <span class="n">setValue</span><span class="p">(</span><span class="n">V</span> <span class="n">value</span><span class="p">)</span>  <span class="p">{</span>  <span class="err"></span> <span class="o">//</span> <span class="n">Implementation</span><span class="o">.</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">protected</span> <span class="n">final</span> <span class="n">void</span> <span class="n">setException</span><span class="p">(</span><span class="n">E</span> <span class="n">exception</span><span class="p">)</span> <span class="p">{</span>  <span class="err"></span> <span class="o">//</span> <span class="n">Implementation</span><span class="o">.</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>It includes an embedded <code>Driver</code> instance and closely resembles the
<code>ResultProducer</code> class in <a href="#embedding-driver">Embedding driver</a> and interfaces
with the SkyFunction in a similar manner. Instead of defining a <code>ResultSink</code>,
implementations call <code>setValue</code> or <code>setException</code> when either of those occur.
When both occur, the exception takes priority. The <code>tryProduceValue</code> method
bridges the asynchronous callback code to synchronous code and throws an
exception when one is set.</p>
<p>As previously noted, during error bubbling, it&rsquo;s possible for an error to occur
even if the machine is not yet done because not all inputs are available. To
accommodate this, <code>tryProduceValue</code> throws any set exceptions, even before the
machine is done.</p>
<h2 id="epilogue-eventually-removing-callbacks">Epilogue: Eventually removing callbacks</h2>
<p><code>StateMachine</code>s are a highly efficient, but boilerplate intensive way to perform
asynchronous computation. Continuations (particularly in the form of <code>Runnable</code>s
passed to <code>ListenableFuture</code>) are widespread in certain parts of <em>Bazel</em> code,
but aren&rsquo;t prevalent in analysis SkyFunctions. Analysis is mostly CPU bound and
there are no efficient asynchronous APIs for disk I/O. Eventually, it would be
good to optimize away callbacks as they have a learning curve and impede
readability.</p>
<p>One of the most promising alternatives is <em>Java</em> virtual threads. Instead of
having to write callbacks, everything is replaced with synchronous, blocking
calls. This is possible because tying up a virtual thread resource, unlike a
platform thread, is supposed to be cheap. However, even with virtual threads,
replacing simple synchronous operations with thread creation and synchronization
primitives is too expensive. We performed a migration from <code>StateMachine</code>s to
<em>Java</em> virtual threads and they were orders of magnitude slower, leading to
almost a 3x increase in end-to-end analysis latency. Since virtual threads are
still a preview feature, it&rsquo;s possible that this migration can be performed at a
later date when performance improves.</p>
<p>Another approach to consider is waiting for <em>Loom</em> coroutines, if they ever
become available. The advantage here is that it might be possible to reduce
synchronization overhead by using cooperative multitasking.</p>
<p>If all else fails, low-level bytecode rewriting could also be a viable
alternative. With enough optimization, it might be possible to achieve
performance that approaches hand-written callback code.</p>
<h2 id="appendix">Appendix</h2>
<h3 id="callback-hell">Callback Hell</h3>
<p>Callback hell is an infamous problem in asynchronous code that uses callbacks.
It stems from the fact that the continuation for a subsequent step is nested
within the previous step. If there are many steps, this nesting can be extremely
deep. If coupled with control flow the code becomes unmanageable.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CallbackHell</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">task</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">doA</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">l</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">doB</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">l2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">doC</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>One of the advantages of nested implementations is that the stack frame of the
outer step can be preserved. In <em>Java</em>, captured lambda variables must be
effectively final so using such variables can be cumbersome. Deep nesting is
avoided by returning method references as continuations instead of lambdas as
shown as follows.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CallbackHellAvoided</span> <span class="n">implements</span> <span class="n">StateMachine</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nd">@Override</span>
</span></span><span class="line"><span class="cl">  <span class="n">public</span> <span class="n">StateMachine</span> <span class="n">step</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">task</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">doA</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="p">::</span><span class="n">step2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">step2</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">doB</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">this</span><span class="p">::</span><span class="n">step3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">private</span> <span class="n">StateMachine</span> <span class="n">step3</span><span class="p">(</span><span class="n">Tasks</span> <span class="n">tasks</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">doC</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">DONE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Callback hell may also occur if the <a href="#runafter-injection"><code>runAfter</code> injection</a>
pattern is used too densely, but this can be avoided by interspersing injections
with sequential steps.</p>
<h4 id="example-chained-skyvalue-lookups">Example: Chained SkyValue lookups</h4>
<p>It is often the case that the application logic requires dependent chains of
SkyValue lookups, for example, if a second SkyKey depends on the first SkyValue.
Thinking about this naively, this would result in a complex, deeply nested
callback structure.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">private ValueType1 value1;
</span></span><span class="line"><span class="cl">private ValueType2 value2;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">private StateMachine step1(...) {
</span></span><span class="line"><span class="cl">  tasks.lookUp(key1, (Consumer&lt;SkyValue&gt;) this);  // key1 has type KeyType1.
</span></span><span class="line"><span class="cl">  return this::step2;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">@Override
</span></span><span class="line"><span class="cl">public void accept(SkyValue value) {
</span></span><span class="line"><span class="cl">  this.value1 = (ValueType1) value;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">private StateMachine step2(...) {
</span></span><span class="line"><span class="cl">  KeyType2 key2 = computeKey(value1);
</span></span><span class="line"><span class="cl">  tasks.lookup(key2, this::acceptValueType2);
</span></span><span class="line"><span class="cl">  return this::step3;
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">private void acceptValueType2(SkyValue value) {
</span></span><span class="line"><span class="cl">  this.value2 = (ValueType2) value;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>However, since continuations are specified as method references, the code looks
procedural across state transitions: <code>step2</code> follows <code>step1</code>. Note that here, a
lambda is used to assign <code>value2</code>. This makes the ordering of the code match the
ordering of the computation from top-to-bottom.</p>
<h3 id="miscellaneous-tips">Miscellaneous Tips</h3>
<h4 id="readability-execution-ordering">Readability: Execution Ordering</h4>
<p>To improve readability, strive to keep the <code>StateMachine.step</code> implementations
in execution order and callback implementations immediately following where they
are passed in the code. This isn&rsquo;t always possible where the control flow
branches. Additional comments might be helpful in such cases.</p>
<p>In <a href="#chained-skyvalue-lookups">Example: Chained SkyValue lookups</a>, an
intermediate method reference is created to achieve this. This trades a small
amount of performance for readability, which is likely worthwhile here.</p>
<h4 id="generational-hypothesis">Generational Hypothesis</h4>
<p>Medium-lived <em>Java</em> objects break the generational hypothesis of the <em>Java</em>
garbage collector, which is designed to handle objects that live for a very
short time or objects that live forever. By definition, objects in
<code>SkyKeyComputeState</code> violate this hypothesis. Such objects, containing the
constructed tree of all still-running <code>StateMachine</code>s, rooted at <code>Driver</code> have
an intermediate lifespan as they suspend, waiting for asynchronous computations
to complete.</p>
<p>It seems less bad in JDK19, but when using <code>StateMachine</code>s, it&rsquo;s sometimes
possible to observe an increase in GC time, even with dramatic decreases in
actual garbage generated. Since <code>StateMachine</code>s have an intermediate lifespan
they could be promoted to old gen, causing it to fill up more quickly, thus
necessitating more expensive major or full GCs to clean up.</p>
<p>The initial precaution is to minimize the use of <code>StateMachine</code> variables, but
it is not always feasible, for example, if a value is needed across multiple
states. Where it is possible, local stack <code>step</code> variables are young generation
variables and efficiently GC&rsquo;d.</p>
<p>For <code>StateMachine</code> variables, breaking things down into subtasks and following
the recommended pattern for <a href="#propagating-values">Propagating values between
<code>StateMachine</code>s</a> is also helpful. Observe that when
following the pattern, only child <code>StateMachine</code>s have references to parent
<code>StateMachine</code>s and not vice versa. This means that as children complete and
update the parents using result callbacks, the children naturally fall out of
scope and become eligible for GC.</p>
<p>Finally, in some cases, a <code>StateMachine</code> variable is needed in earlier states
but not in later states. It can be beneficial to null out references of large
objects once it is known that they are no longer needed.</p>
<h4 id="naming-states">Naming states</h4>
<p>When naming a method, it&rsquo;s usually possible to name a method for the behavior
that happens within that method. It&rsquo;s less clear how to do this in
<code>StateMachine</code>s because there is no stack. For example, suppose method <code>foo</code>
calls a sub-method <code>bar</code>. In a <code>StateMachine</code>, this could be translated into the
state sequence <code>foo</code>, followed by <code>bar</code>. <code>foo</code> no longer includes the behavior
<code>bar</code>. As a result, method names for states tend to be narrower in scope,
potentially reflecting local behavior.</p>
<h3 id="concurrency-tree-diagram">Concurrency tree diagram</h3>
<p>The following is an alternative view of the diagram in <a href="#structured-concurrency">Structured
concurrency</a> that better depicts the tree structure.
The blocks form a small tree.</p>
<p><img src="/contribute/images/structured-concurrency-3d.svg" alt="Structured Concurrency 3D"></p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p>In contrast to Skyframe&rsquo;s convention of restarting from the beginning when
values are not available.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p>Note that <code>step</code> is permitted to throw <code>InterruptedException</code>, but the
examples omit this. There are a few low methods in <em>Bazel</em> code that throw
this exception and it propagates up to the <code>Driver</code>, to be described later,
that runs the <code>StateMachine</code>. It&rsquo;s fine to not declare it to be thrown when
unneeded.&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p>Concurrent subtasks were motivated by the <code>ConfiguredTargetFunction</code> which
performs <em>independent</em> work for each dependency. Instead of manipulating
complex data structures that process all the dependencies at once,
introducing inefficiencies, each dependency has its own independent
<code>StateMachine</code>.&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p>Multiple <code>tasks.lookUp</code> calls within a single step are batched together.
Additional batching can be created by lookups occurring within concurrent
subtasks.&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p>This is conceptually similar to Javas structured concurrency
<a href="https://openjdk.org/jeps/428">jeps/428</a>.&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6">
<p>Doing this is similar to spawning a thread and joining it to achieve
sequential composition.&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

	
</div>


          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="td-footer__left col-6 col-sm-4 order-sm-1">
        
      </div><div class="td-footer__right col-6 col-sm-4 order-sm-3">
        
      </div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2">
        
      </div>
    </div>
  </div>
</footer>

    </div>
    <script src="/js/main.js"></script>
<script defer src="/js/click-to-copy.js" crossorigin="anonymous"></script>
<script src='/js/tabpane-persist.js'></script>

  </body>
</html>