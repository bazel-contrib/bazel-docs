name: Pull Fresh Upstream Documentation

on:
  workflow_call:
    inputs:
      bazelCommitHash:
        description: 'Specific Bazel commit hash to checkout (optional)'
        required: false
        type: string
        default: ''
      is_internal_pr:
        description: 'Whether this is an internal PR (not from a fork)'
        required: false
        type: boolean
        default: true 

jobs:
  pull-fresh-upstream:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - uses: actions/create-github-app-token@v2
        id: generate-token
        if: ${{ inputs.is_internal_pr }}
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout repository (internal PR)
        if: ${{ inputs.is_internal_pr }}
        uses: actions/checkout@v6
        with:
          submodules: false
          token: ${{ steps.generate-token.outputs.token }}

      - name: Checkout repository (fork)
        if: ${{ !inputs.is_internal_pr }}
        uses: actions/checkout@v6
        with:
          submodules: false
          # No token is provided, so the action will use the default GITHUB_TOKEN
          # with fork-safe, read-only permissions.

      - name: Checkout submodules
        run: git submodule update --init -- upstream

      - name: Checkout commit of Bazel Build submodule
        if: ${{ inputs.bazelCommitHash != '' }}
        working-directory: upstream
        run: git checkout '${{ inputs.bazelCommitHash }}'

      - name: Setup Bazel
        uses: bazel-contrib/setup-bazel@0.16.0
        with:
          bazelisk-cache: true
          repository-cache: true
       
      - name: Build reference documentation (if not a fork)
        if: ${{ inputs.is_internal_pr }}
        working-directory: upstream
        run: >
          bazel build
          --config=docs
          --build_metadata=ROLE=DOCS
          --remote_header=x-buildbuddy-api-key=${{ secrets.BUILDBUDDY_ORG_API_KEY }}
          --bes_results_url=https://app.buildbuddy.io/invocation/
          --bes_backend=grpcs://remote.buildbuddy.io
          --remote_cache=grpcs://remote.buildbuddy.io
          --remote_timeout=10m
          //src/main/java/com/google/devtools/build/lib:gen_reference_docs
      
      - name: Upload reference docs artifact
        if: ${{ github.ref != 'refs/heads/main' }}
        uses: actions/upload-artifact@v6
        with:
          name: reference-docs
          path: upstream/bazel-bin/src/main/java/com/google/devtools/build/lib/reference-docs.zip
          retention-days: 7

      - name: Create dummy reference docs for forks
        if: ${{ !inputs.is_internal_pr }}
        run: |
          mkdir -p upstream/bazel-bin/src/main/java/com/google/devtools/build/lib
          touch upstream/bazel-bin/src/main/java/com/google/devtools/build/lib/reference-docs.zip

      - name: Clean up mdx files
        run: ./cleanup-mdx.sh

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25.2'

      - name: Initialize Go module for converter
        if: ${{ inputs.is_internal_pr }}
        run: |
          cd html2md_converter
          go mod init html-to-md-converter
          go get github.com/JohannesKaufmann/html-to-markdown

      - name: Build HTML to Markdown converter
        if: ${{ inputs.is_internal_pr }}
        run: |
          cd html2md_converter
          go build -o html-to-md main.go
            
      - name: Convert reference documentation HTML to Markdown
        if: ${{ inputs.is_internal_pr }}
        run: |
          # Extract and convert HTML reference docs to Markdown
          ./html2md_converter/html-to-md \
            -zip upstream/bazel-bin/src/main/java/com/google/devtools/build/lib/reference-docs.zip \
            -output reference-docs-temp

      - name: Transform upstream docs to mdx
        run: ./copy-upstream-docs.sh

      - name: Create versioned navigation
        run: ./docs.json.update.sh
    
      - name: Clean up temporary files
        if: ${{ inputs.is_internal_pr }}
        run: rm -rf reference-docs-temp

      - name: Configure Git
        if: ${{ inputs.is_internal_pr }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes
        if: ${{ inputs.is_internal_pr }}
        env:
          BRANCH: ${{ github.head_ref || github.ref_name }}
        run: |
          set -euo pipefail
          
          # Ensure local branch points at origin/BRANCH and is checked out
          git fetch origin "$BRANCH"
          git switch -C "$BRANCH" "origin/$BRANCH"
          git branch --set-upstream-to="origin/$BRANCH" "$BRANCH"
          
          # Rebase onto latest remote before creating a new commit
          git pull
          
          # Clean up any modified content in submodules (keep pointer changes)
          # This handles the "modified content" issue while preserving submodule commit updates
          cd upstream
          git reset --hard
          git clean -fd
          cd ..
          
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Changes detected, committing and pushing..."
            git add -A
            git commit -m $'chore: update documentation from upstream Bazel repo\n\nGenerated by GitHub Actions workflow from upstream Bazel repository.\nThis commit includes transformed documentation files ready for Mintlify deployment.'
          
            # Push back to the same branch
            git push origin "HEAD:$BRANCH"
            echo "Changes committed and pushed successfully"
          else
            echo "No changes detected, skipping commit"
          fi
