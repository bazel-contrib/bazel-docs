name: Preview Bazel docs PRs
on:
  # Since PRs to Bazel repo may come from a fork, and those cannot see GHA Secrets,
  # we fall back to polling the Bazel repo for new PRs.
  schedule:
    # Runs every 30 minutes.
    - cron: '*/30 * * * *'
  # Also allow manual triggering in the GH UI.
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Specific bazelbuild/bazel PR number to preview (skips polling, useful for testing)'
        required: false
        type: string
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  list-prs:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.fetch-prs.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6

      - name: Fetch recent PRs
        id: fetch-prs
        env:
          GH_TOKEN: ${{ secrets.BAZELBUILD_BAZEL_PAT || github.token }}
          PR_NUMBER_OVERRIDE: ${{ inputs.pr_number || '' }}
        run: |
          set -euo pipefail

          if [[ -n "${PR_NUMBER_OVERRIDE}" ]]; then
            # Manual dispatch with a specific PR number — fetch just that PR
            pr="$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/bazelbuild/bazel/pulls/${PR_NUMBER_OVERRIDE}")"
            matrix="$(echo "$pr" | jq -c '[{
              number: .number,
              head_sha: .head.sha,
              base_sha: .base.sha,
              head_ref: .head.ref,
              preview_branch: ("pr-" + (.number|tostring))
            }]')"
          else
            # Scheduled run — poll for PRs updated in the last 45 minutes
            since="$(date -u -d '45 minutes ago' '+%Y-%m-%dT%H:%M:%SZ')"
            prs="$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/bazelbuild/bazel/pulls?state=open&sort=updated&direction=desc&per_page=100")"
            matrix="$(echo "$prs" | jq -c --arg since "$since" '
              [
                .[] | select(.updated_at >= $since) |
                {
                  number: .number,
                  head_sha: .head.sha,
                  base_sha: .base.sha,
                  head_ref: .head.ref,
                  preview_branch: ("pr-" + (.number|tostring))
                }
              ]
            ')"
          fi

          echo "Matrix entries: $(echo "$matrix" | jq -r 'length')"
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  build-previews:
    needs: list-prs
    if: ${{ needs.list-prs.outputs.matrix != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.list-prs.outputs.matrix) }}
    uses: ./.github/workflows/pull-from-bazel-build.yml
    secrets: inherit
    with:
      bazelCommitHash: ${{ matrix.head_sha }}
      bazelBaseCommitHash: ${{ matrix.base_sha }}
      bazelPullRequestNumber: ${{ matrix.number }}
      detect_upstream_docs_changes: true
      is_internal_pr: true
      target_branch: ${{ matrix.preview_branch }}

  comment:
    needs: [list-prs, build-previews]
    if: ${{ always() && needs.list-prs.outputs.matrix != '[]' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.list-prs.outputs.matrix || '[]') }}
    steps:
      - name: Post or update preview comment
        env:
          # BAZELBUILD_BAZEL_PAT is required to post comments on bazelbuild/bazel PRs.
          # github.token is used as a fallback for read-only access to this repo.
          GH_TOKEN: ${{ secrets.BAZELBUILD_BAZEL_PAT }}
          GITHUB_TOKEN_FALLBACK: ${{ github.token }}
          PREVIEW_URL: https://bazel-${{ matrix.preview_branch }}.mintlify.app/
          PR_NUMBER: ${{ matrix.number }}
          HEAD_SHA: ${{ matrix.head_sha }}
          BUILD_RESULT: ${{ needs.build-previews.result }}
          PREVIEW_BRANCH: ${{ matrix.preview_branch }}
        run: |
          set -euo pipefail

          marker="<!-- bazel-docs-preview -->"

          # If the preview branch doesn't exist in bazel-contrib/bazel-docs,
          # this PR has no doc-related changes — skip posting a comment.
          # Use github.token for this read-only check since BAZELBUILD_BAZEL_PAT
          # is only needed for writing to bazelbuild/bazel.
          if ! GH_TOKEN="${GITHUB_TOKEN_FALLBACK}" gh api "/repos/${{ github.repository }}/branches/${PREVIEW_BRANCH}" --silent 2>/dev/null; then
            echo "No preview branch for PR #${PR_NUMBER} (no doc changes detected). Skipping comment."
            exit 0
          fi

          if [[ -z "${GH_TOKEN}" ]]; then
            echo "BAZELBUILD_BAZEL_PAT secret is not configured — skipping comment on upstream PR."
            exit 0
          fi

          if [[ "${BUILD_RESULT}" == "success" ]]; then
            body=$(cat <<EOF
          ${marker}

          :white_check_mark: Bazel docs preview is ready!

          **Preview URL:** ${PREVIEW_URL}

          *Updated for \`${HEAD_SHA}\`*
          EOF
          )
          else
            body=$(cat <<EOF
          ${marker}

          :x: Bazel docs preview build failed.

          Please check the [GitHub Actions logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          *Updated for \`${HEAD_SHA}\`*
          EOF
          )
          fi

          existing_id="$(gh api "/repos/bazelbuild/bazel/issues/${PR_NUMBER}/comments" \
            --jq "map(select(.body | contains(\"${marker}\")))[0].id // empty")"

          if [[ -n "${existing_id}" ]]; then
            gh api -X PATCH "/repos/bazelbuild/bazel/issues/comments/${existing_id}" -f body="${body}"
          else
            gh api -X POST "/repos/bazelbuild/bazel/issues/${PR_NUMBER}/comments" -f body="${body}"
          fi

  cleanup:
    needs: [list-prs, build-previews, comment]
    # Only run on scheduled cron — not on manual workflow_dispatch triggers.
    # Runs after build-previews and comment so it never races with an in-progress preview build.
    if: ${{ always() && github.event_name == 'schedule' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Close draft PRs and delete branches for merged/closed upstream PRs
        env:
          GH_TOKEN: ${{ github.token }}
          BAZELBUILD_TOKEN: ${{ secrets.BAZELBUILD_BAZEL_PAT || github.token }}
        run: |
          set -euo pipefail

          # List all pr-* branches in this repo
          branches=$(gh api "repos/${{ github.repository }}/branches?per_page=100" --paginate \
            --jq '[.[].name | select(startswith("pr-"))]')

          echo "Found $(echo "$branches" | jq -r 'length') preview branch(es)"

          for pr_number in $(echo "$branches" | jq -r '.[] | ltrimstr("pr-")'); do
            branch="pr-${pr_number}"

            # Check if the upstream bazelbuild/bazel PR is still open
            state=$(GH_TOKEN="${BAZELBUILD_TOKEN}" gh api "repos/bazelbuild/bazel/pulls/${pr_number}" \
              --jq '.state' 2>/dev/null || echo "not_found")

            if [[ "$state" == "open" ]]; then
              continue
            fi

            echo "Upstream PR #${pr_number} is '${state}'. Cleaning up ${branch}..."

            # Close the draft PR in this repo if one exists
            pr_id=$(gh pr list --repo "${{ github.repository }}" --head "${branch}" \
              --json number --jq '.[0].number // empty')
            if [[ -n "${pr_id}" ]]; then
              gh pr close "${pr_id}" --repo "${{ github.repository }}"
              echo "Closed draft PR #${pr_id}"
            fi

            # Delete the preview branch
            gh api -X DELETE "repos/${{ github.repository }}/git/refs/heads/${branch}" 2>/dev/null \
              && echo "Deleted branch ${branch}" \
              || echo "Branch ${branch} already deleted or not found"
          done
