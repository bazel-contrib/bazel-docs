name: Preview Bazel docs PRs
on:
  # Since PRs to Bazel repo may come from a fork, and those cannot see GHA Secrets,
  # we fall back to polling the Bazel repo for new PRs.
  schedule:
    # Runs every 30 minutes.
    - cron: '*/30 * * * *'
  # Also allow manual triggering in the GH UI.
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'Specific bazelbuild/bazel PR number to preview (skips polling, useful for testing)'
        required: false
        type: string
        default: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  list-prs:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.fetch-prs.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6

      - name: Fetch recent PRs
        id: fetch-prs
        env:
          GH_TOKEN: ${{ secrets.BAZELBUILD_BAZEL_PAT }}
          PR_NUMBER_OVERRIDE: ${{ inputs.pr_number || '' }}
        run: |
          set -euo pipefail

          if [[ -n "${PR_NUMBER_OVERRIDE}" ]]; then
            # Manual dispatch with a specific PR number — fetch just that PR
            pr="$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/bazelbuild/bazel/pulls/${PR_NUMBER_OVERRIDE}")"
            matrix="$(echo "$pr" | jq -c '[{
              number: .number,
              head_sha: .head.sha,
              base_sha: .base.sha,
              head_ref: .head.ref,
              preview_branch: ("pr-" + (.number|tostring))
            }]')"
          else
            # Scheduled run — poll for PRs updated in the last 45 minutes
            since="$(date -u -d '45 minutes ago' '+%Y-%m-%dT%H:%M:%SZ')"
            prs="$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/repos/bazelbuild/bazel/pulls?state=open&sort=updated&direction=desc&per_page=100")"
            matrix="$(echo "$prs" | jq -c --arg since "$since" '
              [
                .[] | select(.updated_at >= $since) |
                {
                  number: .number,
                  head_sha: .head.sha,
                  base_sha: .base.sha,
                  head_ref: .head.ref,
                  preview_branch: ("pr-" + (.number|tostring))
                }
              ]
            ')"
          fi

          echo "Matrix entries: $(echo "$matrix" | jq -r 'length')"
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  build-previews:
    needs: list-prs
    if: ${{ needs.list-prs.outputs.matrix != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.list-prs.outputs.matrix) }}
    uses: ./.github/workflows/pull-from-bazel-build.yml
    secrets: inherit
    with:
      bazelCommitHash: ${{ matrix.head_sha }}
      bazelBaseCommitHash: ${{ matrix.base_sha }}
      bazelPullRequestNumber: ${{ matrix.number }}
      detect_upstream_docs_changes: true
      is_internal_pr: true
      target_branch: ${{ matrix.preview_branch }}

  comment:
    needs: [list-prs, build-previews]
    if: ${{ always() && needs.list-prs.outputs.matrix != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.list-prs.outputs.matrix) }}
    steps:
      - name: Post or update preview comment
        env:
          GH_TOKEN: ${{ secrets.BAZELBUILD_BAZEL_PAT }}
          PREVIEW_URL: https://bazel-${{ matrix.preview_branch }}.mintlify.app/
          PR_NUMBER: ${{ matrix.number }}
          HEAD_SHA: ${{ matrix.head_sha }}
          BUILD_RESULT: ${{ needs.build-previews.result }}
          PREVIEW_BRANCH: ${{ matrix.preview_branch }}
        run: |
          set -euo pipefail

          marker="<!-- bazel-docs-preview -->"

          # If the preview branch doesn't exist in bazel-contrib/bazel-docs,
          # this PR has no doc-related changes — skip posting a comment.
          if ! gh api "/repos/${{ github.repository }}/branches/${PREVIEW_BRANCH}" --silent 2>/dev/null; then
            echo "No preview branch for PR #${PR_NUMBER} (no doc changes detected). Skipping comment."
            exit 0
          fi

          if [[ "${BUILD_RESULT}" == "success" ]]; then
            body=$(cat <<EOF
          ${marker}

          :white_check_mark: Bazel docs preview is ready!

          **Preview URL:** ${PREVIEW_URL}

          *Updated for \`${HEAD_SHA}\`*
          EOF
          )
          else
            body=$(cat <<EOF
          ${marker}

          :x: Bazel docs preview build failed.

          Please check the [GitHub Actions logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

          *Updated for \`${HEAD_SHA}\`*
          EOF
          )
          fi

          existing_id="$(gh api "/repos/bazelbuild/bazel/issues/${PR_NUMBER}/comments" \
            --jq "map(select(.body | contains(\"${marker}\")))[0].id // empty")"

          if [[ -n "${existing_id}" ]]; then
            gh api -X PATCH "/repos/bazelbuild/bazel/issues/comments/${existing_id}" -f body="${body}"
          else
            gh api -X POST "/repos/bazelbuild/bazel/issues/${PR_NUMBER}/comments" -f body="${body}"
          fi
